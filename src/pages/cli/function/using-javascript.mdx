export const meta = {
  title: `Using JavaScript`,
  description: `Learn how to use JavaScript with AWS Lambda functions`
};

## Using Native ES Modules

AWS Lambda [has announced support for ECMAScript (ES) Modules and Top-Level Await for Node.js 14](https://aws.amazon.com/about-aws/whats-new/2022/01/aws-lambda-es-modules-top-level-await-node-js-14/) which can be used with functions created by the Amplify CLI.

Let's start with creating a function named `hellofunction` using the "Hello World" function template:

```console
$ amplify add function
? Select which capability you want to add: Lambda function (serverless function)
? Provide an AWS Lambda function name: hellofunction
? Choose the runtime that you want to use: NodeJS
? Choose the function template that you want to use: Hello World

Available advanced settings:
- Resource access permissions
- Scheduled recurring invocation
- Lambda layers configuration
- Environment variables configuration
- Secret values configuration

? Do you want to configure advanced settings? No
? Do you want to edit the local lambda function now? Yes
```

After creating the function we are presented with the following template:

```js
exports.handler = async (event) => {
  // TODO implement
  const response = {
    statusCode: 200,
    //  Uncomment below to enable CORS requests
    // headers: {
    //   'Access-Control-Allow-Origin': '*',
    //   'Access-Control-Allow-Headers': '*'
    // },
    body: JSON.stringify('Hello from Lambda!')
  };
  return response;
};
```

To enable ESM support we will need to define the package type as "module" in the function's `package.json`:

```diff
{
  "name": "hellofunction",
+ "type": "module",
  "version": "2.0.0",
  "description": "Lambda function generated by Amplify",
- "main": "index.js",
+ "module": "index.js",
  "license": "Apache-2.0"
}
```

In the context of an ESM package the `main` field will indicate the CommonJS entry point, where the `module` field will indicate the ES Module entry point. It is worth noting that the `main` field is not required for an ESM package, however leaving this field unchanged will not affect function execution.

To optionally add support for proper JSDoc annotations -- which will provide [IntelliSense](https://code.visualstudio.com/docs/editor/intellisense) support -- we will need to install `@types/aws-lambda` as a devDependency of the project:

```bash
cd amplify/backend/function/hellofunction/src; npm install --save-dev @types/aws-lambda; cd -
```

Now we are able to adjust the function's template code from CommonJS to ESM:

```js
// amplify/backend/function/hellofunction/src/index.js
/**
 * @param {number} seconds
 * @returns {Promise<void>}
 */
function sleep(seconds) {
  const milliseconds = Math.floor(seconds * 1000);
  return new Promise((resolve) => setTimeout(resolve, milliseconds));
}

// top-level await
await sleep(2);

/**
 * @type {import('@types/aws-lambda').APIGatewayProxyHandler}
 */
export async function handler(event) {
  return {
    statusCode: 200,
    // headers: {
    //   'Access-Control-Allow-Origin': '*',
    //   'Access-Control-Allow-Headers': '*'
    // },
    body: JSON.stringify('Hello from Lambda!')
  };
}
```

The sample above leverages [top-level await](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await#top_level_await) which enables us to use asynchronous functions in the top-level scope of the function. When executing this function it will wait two seconds before returning the body, "Hello from Lambda!".

Finally, we can attach the function to an API Gateway resource on the `/hello` route:

```console
$ amplify add api
? Select from one of the below mentioned services: REST
✔ Provide a friendly name for your resource to be used as a label for this category in the project: · myapi
✔ Provide a path (e.g., /book/{isbn}): · /hello
✔ Choose a Lambda source · Use a Lambda function already added in the current Amplify project
Only one option for [Choose the Lambda function to invoke by this path]. Selecting [hellofunction].
✔ Restrict API access? (Y/n) · no
✔ Do you want to add another path? (y/N) · no
✅ Successfully added resource myapi locally
```

Once complete, push the newly created resources with `amplify push` and call the `/hello` route on the REST API endpoint URL outputted to the console:

```bash
$ curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev/hello
"Hello from Lambda!"
```

In the end we have a functional Node.js Lambda written using ECMAScript Modules!

## Transpiling JavaScript

// TODO - add esbuild
