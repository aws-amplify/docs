import { getCustomStaticPath } from '@/utils/getCustomStaticPath';

export const meta = {
  title: 'Manage users with admin actions',
  description: 'Learn how to manage users with Admin Actions',
  platforms: [
    'android',
    'angular',
    'flutter',
    'javascript',
    'nextjs',
    'react',
    'react-native',
    'swift',
    'vue'
  ]
};

export function getStaticPaths() {
  return getCustomStaticPath(meta.platforms);
}

export function getStaticProps() {
  return {
    props: {
      meta,
    }
  };
}

Amplify Auth can be managed with the [AWS SDK's `@aws-sdk/client-cognito-identity-provider` package](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cognito-identity-provider/). This package is intended to use server-side, and can be used within a Function. This example focuses on the `addUserToGroup` action and will be defined as a [custom mutation](/[platform]/build-a-backend/data/custom-business-logic/#step-1---define-a-custom-query-or-mutation).

To get started, create an "ADMINS" group that will be used to authorize the mutation:

```ts title="amplify/auth/resource.ts"
import { defineAuth } from "@aws-amplify/backend"

export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  // highlight-next-line
  groups: ["ADMINS"]
})
```

Next, create the Function resource:

```ts title="amplify/data/add-user-to-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const addUserToGroup = defineFunction({
  name: "add-user-to-group",
})
```

Then, in your auth resources, grant access for the function to perform the `addUserToGroup` action. [Learn more about granting access to auth resources](/[platform]/build-a-backend/auth/grant-access-to-auth-resources).

```ts title="amplify/auth/resource.ts"
import { defineAuth } from "@aws-amplify/backend"
// highlight-next-line
import { addUserToGroup } from "../data/add-user-to-group/resource"

export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  groups: ["ADMINS"],
  // highlight-start
  access: (allow) => [
    allow.resource(addUserToGroup).to(["addUserToGroup"])
  ],
  // highlight-end
})
```

You're now ready to define the custom mutation. Here you will use the newly-created `addUserToGroup` function resource to handle the `addUserToGroup` mutation. This mutation can only be called by a user in the "ADMINS" group.

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a, defineData } from "@aws-amplify/backend"
import { addUserToGroup } from "./resource"

const schema = a.schema({
  addUserToGroup: a
    .mutation()
    .arguments({
      userId: a.string().required(),
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(addUserToGroup))
    .returns(a.json())
})

export type Schema = ClientSchema<typeof schema>

export const data = defineData({
  schema,
  authorizationModes: {
    defaultAuthorizationMode: "iam",
  },
})
```

Lastly, create the function's handler using the exported client schema to type the handler function, and the generated `env` to specify the user pool ID you'd like to interact with:

```ts title="amplify/data/add-user-to-group/handler.ts"
import type { Schema } from "../resource"
import {
  AdminAddUserToGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"
import { env } from "$amplify/env/add-user-to-group"

type Handler = Schema["addUserToGroup"]["functionHandler"]
const client = new CognitoIdentityProviderClient()

export const handler: Handler = async (event) => {
  const { userId, groupName } = event.arguments
  const command = new AdminAddUserToGroupCommand({
    Username: userId,
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

{/* double-up the filter for web platforms until mobile examples are written */}
<InlineFilter filters={["angular", "javascript", "nextjs", "react", "react-native", "vue"]}>

In your frontend, use the generated client to call your mutation using the group name and the user's ID.

<InlineFilter filters={["angular", "javascript", "nextjs", "react", "react-native", "vue"]}>

```ts title="src/client.ts"
import type { Schema } from "../amplify/data/resource"
import { generateClient } from "aws-amplify/data"

const client = generateClient<Schema>()

await client.mutations.addUserToGroup({
  groupName: "ADMINS",
  userId: "5468d468-4061-70ed-8870-45c766d26225",
})
```

</InlineFilter>
<InlineFilter filters={["flutter"]}>

{/* @todo */}

</InlineFilter>
<InlineFilter filters={["android"]}>

{/* @todo */}

</InlineFilter>
<InlineFilter filters={["swift"]}>

{/* @todo */}

</InlineFilter>
</InlineFilter>

## Examples

Leveraging the techniques described above, actions can be expanded beyond adding a user to a group to manage users, their attributes, their group membership, and more. Each of the following examples must be assigned access to perform actions against your auth resource:

```ts title="amplify/auth/resource.ts"
import { defineAuth } from "@aws-amplify/backend"
import { addUserToGroup } from "../data/add-user-to-group/resource"
import { removeUserFromGroup } from "../data/remove-user-from-group/resource"
import { createGroup } from "../data/create-group/resource"
import { deleteGroup } from "../data/delete-group/resource"
import { enableUser } from "../data/enable-user/resource"
import { disableUser } from "../data/disable-user/resource"
import { listUsersInGroup } from "../data/list-users-in-group/resource"
import { listGroupsForUser } from "../data/list-groups-for-user/resource"

/**
 * Define and configure your auth resource
 * @see https://docs.amplify.aws/gen2/build-a-backend/auth
 */
export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  groups: ["ADMINS"],
  access: (allow) => [
    allow.resource(addUserToGroup).to(["addUserToGroup"]),
    allow.resource(removeUserFromGroup).to(["removeUserFromGroup"]),
    allow.resource(createGroup).to(["createGroup"]),
    allow.resource(deleteGroup).to(["deleteGroup"]),
    allow.resource(enableUser).to(["enableUser"]),
    allow.resource(disableUser).to(["disableUser"]),
    allow.resource(listUsersInGroup).to(["listUsersInGroup"]),
    allow.resource(listGroupsForUser).to(["listGroupsForUser"]),
  ],
})
```

### Add a user to a group

```ts title="amplify/data/add-user-to-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const addUserToGroup = defineFunction({
  name: "add-user-to-group",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { addUserToGroup } from "./add-user-to-group/resource"

const schema = a.schema({
  addUserToGroup: a
    .mutation()
    .arguments({
      userId: a.string().required(),
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(addUserToGroup))
    .returns(a.json()),
})
```

```ts title="amplify/data/add-user-to-group/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/add-user-to-group"
import {
  AdminAddUserToGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["addUserToGroup"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { userId, groupName } = event.arguments
  const command = new AdminAddUserToGroupCommand({
    Username: userId,
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### Remove a user from a group

```ts title="amplify/data/remove-user-from-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const removeUserFromGroup = defineFunction({
  name: "remove-user-from-group",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { removeUserFromGroup } from "./remove-user-from-group/resource"

const schema = a.schema({
  removeUserFromGroup: a
    .mutation()
    .arguments({
      userId: a.string().required(),
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(removeUserFromGroup))
    .returns(a.json()),
})
```

```ts title="amplify/data/remove-user-from-group/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/remove-user-from-group"
import {
  AdminRemoveUserFromGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["removeUserFromGroup"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { userId, groupName } = event.arguments
  const command = new AdminRemoveUserFromGroupCommand({
    Username: userId,
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### Create a group

```ts title="amplify/data/create-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const createGroup = defineFunction({
  name: "create-group",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { createGroup } from "./create-group/resource"

const schema = a.schema({
  createGroup: a
    .mutation()
    .arguments({
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(createGroup))
    .returns(a.json()),
})
```

```ts title="amplify/data/create-group/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/create-group"
import {
  CreateGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["createGroup"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { groupName } = event.arguments
  const command = new CreateGroupCommand({
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### Delete a group

```ts title="amplify/data/delete-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const deleteGroup = defineFunction({
  name: "delete-group",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { deleteGroup } from "./delete-group/resource"

const schema = a.schema({
  deleteGroup: a
    .mutation()
    .arguments({
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(deleteGroup))
    .returns(a.json()),
})
```

```ts title="amplify/data/delete-group/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/delete-group"
import {
  DeleteGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["deleteGroup"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { groupName } = event.arguments
  const command = new DeleteGroupCommand({
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### Enable a user

```ts title="amplify/data/enable-user/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const enableUser = defineFunction({
  name: "enable-user",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { enableUser } from "./enable-user/resource"

const schema = a.schema({
  enableUser: a
    .mutation()
    .arguments({
      userId: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(enableUser))
    .returns(a.json()),
})
```

```ts title="amplify/data/enable-user/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/enable-user"
import {
  AdminEnableUserCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["enableUser"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { userId } = event.arguments
  const command = new AdminEnableUserCommand({
    Username: userId,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### Disable a user

```ts title="amplify/data/disable-user/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const disableUser = defineFunction({
  name: "disable-user",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { disableUser } from "./disable-user/resource"

const schema = a.schema({
  disableUser: a
    .mutation()
    .arguments({
      userId: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(disableUser))
    .returns(a.json()),
})
```

```ts title="amplify/data/disable-user/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/disable-user"
import {
  AdminDisableUserCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["disableUser"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { userId } = event.arguments
  const command = new AdminDisableUserCommand({
    Username: userId,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### List groups for a user

```ts title="amplify/data/list-groups-for-user/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const listGroupsForUser = defineFunction({
  name: "list-groups-for-user",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { listGroupsForUser } from "./list-groups-for-user/resource"

const schema = a.schema({
  listGroupsForUser: a
    .query()
    .arguments({
      userId: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(listGroupsForUser))
    .returns(a.json()),
})
```

```ts title="amplify/data/list-groups-for-user/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/list-groups-for-user"
import {
  AdminListGroupsForUserCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["listGroupsForUser"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { userId } = event.arguments
  const command = new AdminListGroupsForUserCommand({
    Username: userId,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```

### List users in a group

```ts title="amplify/data/list-users-in-group/resource.ts"
import { defineFunction } from "@aws-amplify/backend"

export const listUsersInGroup = defineFunction({
  name: "list-users-in-group",
})
``` 

```ts title="amplify/data/resource.ts"
import type { ClientSchema } from "@aws-amplify/backend"
import { a } from "@aws-amplify/backend"
import { listUsersInGroup } from "./list-users-in-group/resource"

const schema = a.schema({
  listUsersInGroup: a
    .query()
    .arguments({
      groupName: a.string().required(),
    })
    .authorization((allow) => [allow.group("ADMINS")])
    .handler(a.handler.function(listUsersInGroup))
    .returns(a.json()),
})
```

```ts title="amplify/data/list-users-in-group/handler.ts"
import type { Schema } from "../resource"
import { env } from "$amplify/env/list-users-in-group"
import {
  ListUsersInGroupCommand,
  CognitoIdentityProviderClient,
} from "@aws-sdk/client-cognito-identity-provider"

const client = new CognitoIdentityProviderClient()
type Handler = Schema["listUsersInGroup"]["functionHandler"]

export const handler: Handler = async (event) => {
  const { groupName } = event.arguments
  const command = new ListUsersInGroupCommand({
    GroupName: groupName,
    UserPoolId: env.AMPLIFY_AUTH_USERPOOL_ID,
  })
  const response = await client.send(command)
  return response
}
```
