import { getCustomStaticPath } from '@/utils/getCustomStaticPath';

export const meta = {
  title: 'Migrate from v5 to v6',
  description: 'Learn more about the migration steps to upgrade Analytics APIs for Amplify JavaScript v5 to v6',
  platforms: [
    'javascript',
    'react-native',
    'angular',
    'nextjs',
    'react',
    'vue'
  ]
};

export const getStaticPaths = async () => {
  return getCustomStaticPath(meta.platforms);
};

export function getStaticProps(context) {
  return {
    props: {
      platform: context.params.platform,
      meta
    }
  };
}

This guide will help you migrate Amplify JavaScript v5's Analytics APIs to the new v6's Analytics APIs.

As of v6 of Amplify, you will now import APIs directly from the `aws-amplify/analytics` path when using the Pinpoint provider. If you are using the Personalize, Kinesis, or Kinesis (Stream) provider, you will need to import separate APIs from the appropriate subpath (ie `import { record } from 'aws-amplify/analytics/personalize'` when using the `record` API with the `AmazonPersonalize` provider) instead of passing in the `provider` or `options.provider` parameter.

<Callout>TODO: The `startSession` API has been removed in v6. (Due to auto-track capabilities?)</Callout>

## Enable and Disable

In both v5 and v6, Analytics is enabled by default. You can disable and enable all Analytics providers using the `enable` and `disable` APIs exported from the `aws-amplify/analytics` path.

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { enable, disable } from 'aws-amplify/analytics';

    // disable all Analytics providers (enabled by default)
    disable();

    // enable all Analytics providers
    enable();
    ```

  </Block>
  <Block name="V5">    
    ```ts
    import { Analytics } from 'aws-amplify';

    Analytics.disable();

    Analytics.enable();
    ```

  </Block>
</BlockSwitcher>

## Pinpoint

In v6, `provider` is determined by import path. To use Pinpoint APIs you will import directly from `aws-amplify/analytics`. These APIs no longer accept parameters specific to Kinesis or Personalize.

### Analytics.record

There are a couple of changes to be aware of in v6:

- The `record` API is now synchronous and does not return since events are always buffered.
- The `immediate` option was removed from the `record` API in v6. Alternatively in v6 you can use the [flushEvents API](/[platform]/build-a-backend/more-features/analytics/record-events/#flush-events) to clear all events from the buffer before calling `record`.
- The `provider` parameter has been removed and provider will be determined by import path. The Pinpoint `record` API no longer accept Personalize and Kinesis events in v6.

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      event: AnalyticsEvent | PersonalizeAnalyticsEvent | KinesisAnalyticsEvent // AnalyticsEvent only in v6
      provider?: string // removed in v6

      // Pinpoint
      AnalyticsEvent {
        name: string;
        attributes?: EventAttributes;
        metrics?: EventMetrics;
        immediate?: boolean; // removed in v6
      }
      ```

    </div>
    <div>
      **V6**

      ```
      input: {
        name: string;
        attributes?: Record<string, string>;
        metrics?: Record<string, number>;
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { record } from 'aws-amplify/analytics';

    record({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics } from 'aws-amplify';

    Analytics.record({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });
    ```

  </Block>
</BlockSwitcher>

### Analytics.autoTrack

The `autoTrack` API has been renamed to `configureAutoTrack` in v6 to make the purpose of this API more clear. In v6, `provider` is determined by import path. To use the Pinpoint `configureAutoTrack` API you will import directly from `aws-amplify/analytics`.

The functionality of this API has not changed, however the input structure has been altered in the following ways:

- We have transitioned from positional parameters to named parameters.
- The `opts` property has been renamed to `options`.
- The required `enable` property has been moved outside of the `options` field.
- `trackerType` has been renamed to `type`.
- Optional tracker options have been moved into the `options` field for all tracker types.
- The `type` parameter in the `pageView` input type has been renamed ot `appType` to differentiate from the tracker `type`.
- The `appType` values `SPA` and `multiPageApp` have been renamed to `singlePage` and `multiPage` respectively.

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      trackerType: 'pageView' | 'event' | 'session'
		  opts: { 
        provider: string; // removed in v6
        enable: boolean;
        attributes?: // simplified in v6: no longer accepts a function
          | (() => [key: string]: string | Promise<[key: string]: string>)
	        | [key: string]: string;
        // trackerType: pageView
        eventName?: string;
        type?: 'SPA' | 'multiPageApp';
        getUrl?: () => string; // renamed urlProvider in v6
        // trackerType: event
        events?: string[];
	      selectorPrefix?: string;
      }
      ```

    </div>
    <div>
      **V6**

      ```
      input {
        enable: boolean;
        type: 'session' | 'pageView' | 'event'
        options?: {
          attributes?: Record<string, string>;
          // type: pageView
          eventName?: string;
          urlProvider?: (() => string);
          appType?: 'multiPage' | 'singlePage';
          // type: event
          events?: (keyof GlobalEventHandlersEventMap)[]; // 'abort' | 'animationcancel' | 'animationend' | ...
          selectorPrefix?: string;
        };
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { configureAutoTrack } from 'aws-amplify/analytics';
    
    configureAutoTrack({
      enable: true,
      type: 'session',
      options: {
        attributes: {
          customizableField: 'attr'
        }
      }
    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics } from 'aws-amplify';
    
    Analytics.autoTrack('session', {
      enable: true,
      attributes: {
        customizableField: 'attr'
      }
    });
    ```

  </Block>
</BlockSwitcher>

### Analytics.updateEndpoint

This API has been renamed to `identifyUser` in v6 to align with other platforms. The functionality is the same, although the type definition is more specific.

- The `address`, `optOut`, and `channelType` options are no longer available as they do not affect Analytics endpoints.
- `attributes` has been renamed to `customProperties`.
- The `provider` parameter has been removed and provider will be determined by import path.

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      attrs: { [key: string]: any; }
      provider?: string

      // The attrs parameter type is generic in v5
      // Below are the properties expected by the API
      attrs: {
        address?: string; // removed in v6
        attributes?: { [key: string]: any; }; // renamed customProperties in v6
        channelType?: string; // removed in v6
        demographic?: {
          appVersion?: string;
          locale?: string;
          make?: string;
          model?: string;
          modelVersion?: string;
          platform?: string;
          platformVersion?: string;
          timezone?: string;
        },
        location?: {
          city?: string;
          country?: string;
          latitude?: number;
          longitude?: number;
          postalCode?: string;
          region?: string;
        },
        metrics?: { [key: string]: any; };
        optOut?: string; // removed in v6
        userId: string;
        userAttributes?: { [key: string]: any; }; // moved under options in v6
      }
      ```

    </div>
    <div>
      **V6**

      ```
      input: {
        userId: string;
        userProfile: {
          customProperties?: Record<string, string[]>;
          demographic?: {
            appVersion?: string;
            locale?: string;
            make?: string;
            model?: string;
            modelVersion?: string;
            platform?: string;
            platformVersion?: string;
            timezone?: string;
          };
          email?: string;
          location?: {
            city?: string;
            country?: string;
            latitude?: number;
            longitude?: number;
            postalCode?: string;
            region?: string;
          };
          metrics?: Record<string, number>;
          name?: string;
          plan?: string;
        };
        options?: { userAttributes?: Record<string, string[]>; };
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { identifyUser } from 'aws-amplify/analytics';

    identifyUser({
      userId: 'xxxxxxx',
      userProfile: {
        customProperties: { hobbies: ['piano', 'hiking'] },
      },
      options: {
        userAttributes: {
          interests: ['football', 'basketball', 'AWS']
        }
      }
    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics } from 'aws-amplify';

    Analytics.updateEndpoint({
      userId: 'xxxxxxx',
      attributes: { hobbies: ['piano', 'hiking'] },
      userAttributes: {
        interests: ['football', 'basketball', 'AWS']
      }
    });
    ```

  </Block>
</BlockSwitcher>

## Record and Configuration APIs

As of v6 of Amplify JavaScript, you will now import the functional API’s directly from the `aws-amplify/analytics` path as shown below. 

Note: Red lines of code are v5 and Green lines are v6.

```diff
- import { Analytics } from 'aws-amplify';
+ import { enable, disable, record, configureAutoTrack } from 'aws-amplify/analytics';

- Analytics.disable();
+ disable();

- Analytics.enable();
+ enable();

- Analytics.record({
-   name: 'albumVisit',
-   attributes: {},
-   metrics: { minutesListened: 30 }
- });

+ record({
+   name: 'albumVisit',
+   attributes: { genre: '', artist: '' }
+ });

- Analytics.autoTrack('session', {
-   // REQUIRED, turn on/off the auto tracking
-   enable: true,
-   // OPTIONAL, the attributes of the event, you can either pass an object or a function
-   // which allows you to define dynamic attributes
-   attributes: {
-     attr: 'attr'
-   },
-   // OPTIONAL, the service provider, by default is the Amazon Pinpoint
-   provider: 'AWSPinpoint'
- });

+ configureAutoTrack({
+   // REQUIRED, turn on/off the auto tracking
+   enable: true,
+   // REQUIRED, the event type, it's one of 'event', 'pageView' or 'session'
+   type: 'session',
+   // OPTIONAL, additional options for the tracked event.
+   options: {
+     // OPTIONAL, the attributes of the event
+     attributes: {
+       customizableField: 'attr'
+     }
+   }
+ });
```
### Analytics.identifyUser

You can identify an Analytics user with the `identifyUser` API, 

```ts
import { identifyUser } from 'aws-amplify/analytics';

identifyUser({
  userId: '<user-id>', // If the user was signed in through Amplify Auth's signIn method you can retrieve the current user's ID from there.
  userProfile
});

```
## Streaming data
You can stream analytics data to Kinesis. To configure Kinesis with Amplify, reference the [Installation and Configuration](https://docs.amplify.aws/react/build-a-backend/more-features/analytics/streaming-data/#installation-and-configuration) section of the documentation. Below is an example on how to stream data and flush events,

```ts
import { record, flushEvents } from 'aws-amplify/analytics/kinesis';

record({
  data: {
    // The data blob to put into the record
  },
  partitionKey: 'myPartitionKey',
  streamName: 'myKinesisStream'
});

flushEvents();
```
Finally, let's look at the difference in how to personalize recommendations,

```diff
- import { Analytics, AmazonPersonalizeProvider } from 'aws-amplify';
- Analytics.addPluggable(new AmazonPersonalizeProvider());

+ import { record } from 'aws-amplify/analytics/personalize';


- Analytics.record({
-     eventType: "Identify",
-     properties: {
-         "userId": "<USER_ID>"
-     }
- }, 'AmazonPersonalize');

+ record({
+   eventType: "Identify",
+   properties: {
+      userId: "<USER_ID>"
+   }
+ });

```
Notice that in v5, the `Analytics.record` API takes in a second parameter with the string value `AmazonPersonalize` whereas in v6, the `record` function is imported from the `aws-amplify/analytics/personalize` subpath and takes only one parameter. 

## Kinesis

### Analytics.record

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      event: AnalyticsEvent | PersonalizeAnalyticsEvent | KinesisAnalyticsEvent
      provider?: string // removed in v6

      // Pinpoint
      AnalyticsEvent {
        name: string;
        attributes?: EventAttributes;
        metrics?: EventMetrics;
        immediate?: boolean;
      }

      // Personalize
      PersonalizeAnalyticsEvent {
        eventType?: string;
        userId?: string;
        properties?: {
          [key: string]: string;
        };
      }

      // Kinesis or Kinesis (Firehose)
      KinesisAnalyticsEvent {
        data: object | string;
        partitionKey: string;
        streamName: string;
        immediate?: boolean;
      }
      ```

    </div>
    <div>
      **V6**

      ```
      // Pinpoint
      input: {
        name: string;
        attributes?: Record<string, string>;
        metrics?: Record<string, number>;
      } 

      // Personalize
      input: {
        userId?: string;
        eventId?: string;
        eventType: string;
        properties: Record<string, unknown>;
      }

      // Kinesis
      input: {
        streamName: string;
        partitionKey: string;
        data: Record<string, unknown> | Uint8Array;
      }

      // Kinesis (Firehose)
      input: {
        streamName: string;
        data: KinesisEventData;
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { record as pinpointRecord } from 'aws-amplify/analytics';
    import { record as personalizeRecord } from 'aws-amplify/analytics/personalize';
    import { record as kinesisRecord } from 'aws-amplify/analytics/kinesis';
    import { record as kinesisFirehoseRecord } from 'aws-amplify/analytics/kinesis-firehose';

    // Pinpoint
    pinpointRecord({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    personalizeRecord({
      eventType: 'Identify',
      properties: {
        userId: 'userId'
      }
    });

    // Kinesis
    kinesisRecord({
      data: {
        // The data blob to put into the record
      },
      partitionKey: 'myPartitionKey',
      streamName: 'myKinesisStream'
    });

    // Kinesis (Firehose)
    kinesisFirehoseRecord({

    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics, AmazonPersonalizeProvider, AWSKinesisProvider, AWSKinesisFirehoseProvider } from 'aws-amplify';
    Analytics.addPluggable(new AmazonPersonalizeProvider());
    Analytics.addPluggable(new AWSKinesisProvider());
    Analytics.addPluggable(new AWSKinesisFirehoseProvider());

    // Pinpoint
    Analytics.record({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AmazonPersonalize');

    // Kinesis
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisProvider');

    // Kinesis (Firehose)
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisFirehoseProvider');

    ```

  </Block>
</BlockSwitcher>

## Kinesis (Firehose)

### Analytics.record

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      event: AnalyticsEvent | PersonalizeAnalyticsEvent | KinesisAnalyticsEvent
      provider?: string // removed in v6

      // Pinpoint
      AnalyticsEvent {
        name: string;
        attributes?: EventAttributes;
        metrics?: EventMetrics;
        immediate?: boolean;
      }

      // Personalize
      PersonalizeAnalyticsEvent {
        eventType?: string;
        userId?: string;
        properties?: {
          [key: string]: string;
        };
      }

      // Kinesis or Kinesis (Firehose)
      KinesisAnalyticsEvent {
        data: object | string;
        partitionKey: string;
        streamName: string;
        immediate?: boolean;
      }
      ```

    </div>
    <div>
      **V6**

      ```
      // Pinpoint
      input: {
        name: string;
        attributes?: Record<string, string>;
        metrics?: Record<string, number>;
      } 

      // Personalize
      input: {
        userId?: string;
        eventId?: string;
        eventType: string;
        properties: Record<string, unknown>;
      }

      // Kinesis
      input: {
        streamName: string;
        partitionKey: string;
        data: Record<string, unknown> | Uint8Array;
      }

      // Kinesis (Firehose)
      input: {
        streamName: string;
        data: KinesisEventData;
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { record as pinpointRecord } from 'aws-amplify/analytics';
    import { record as personalizeRecord } from 'aws-amplify/analytics/personalize';
    import { record as kinesisRecord } from 'aws-amplify/analytics/kinesis';
    import { record as kinesisFirehoseRecord } from 'aws-amplify/analytics/kinesis-firehose';

    // Pinpoint
    pinpointRecord({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    personalizeRecord({
      eventType: 'Identify',
      properties: {
        userId: 'userId'
      }
    });

    // Kinesis
    kinesisRecord({
      data: {
        // The data blob to put into the record
      },
      partitionKey: 'myPartitionKey',
      streamName: 'myKinesisStream'
    });

    // Kinesis (Firehose)
    kinesisFirehoseRecord({

    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics, AmazonPersonalizeProvider, AWSKinesisProvider, AWSKinesisFirehoseProvider } from 'aws-amplify';
    Analytics.addPluggable(new AmazonPersonalizeProvider());
    Analytics.addPluggable(new AWSKinesisProvider());
    Analytics.addPluggable(new AWSKinesisFirehoseProvider());

    // Pinpoint
    Analytics.record({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AmazonPersonalize');

    // Kinesis
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisProvider');

    // Kinesis (Firehose)
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisFirehoseProvider');

    ```

  </Block>
</BlockSwitcher>

## Personalize

To use the personalize provider in v5, you had to pass in an additional parameter to Analytics API's with the string value `AmazonPersonalize`. In v6, however, you will import the APIs from the `aws-amplify/analytics/personalize` subpath instead.

### Analytics.record

<Accordion title='Input' headingLevel='3'>
  <Columns columns={2}>
    <div>
      **V5**

      ```
      event: AnalyticsEvent | PersonalizeAnalyticsEvent | KinesisAnalyticsEvent
      provider?: string // removed in v6

      // Pinpoint
      AnalyticsEvent {
        name: string;
        attributes?: EventAttributes;
        metrics?: EventMetrics;
        immediate?: boolean;
      }

      // Personalize
      PersonalizeAnalyticsEvent {
        eventType?: string;
        userId?: string;
        properties?: {
          [key: string]: string;
        };
      }

      // Kinesis or Kinesis (Firehose)
      KinesisAnalyticsEvent {
        data: object | string;
        partitionKey: string;
        streamName: string;
        immediate?: boolean;
      }
      ```

    </div>
    <div>
      **V6**

      ```
      // Pinpoint
      input: {
        name: string;
        attributes?: Record<string, string>;
        metrics?: Record<string, number>;
      } 

      // Personalize
      input: {
        userId?: string;
        eventId?: string;
        eventType: string;
        properties: Record<string, unknown>;
      }

      // Kinesis
      input: {
        streamName: string;
        partitionKey: string;
        data: Record<string, unknown> | Uint8Array;
      }

      // Kinesis (Firehose)
      input: {
        streamName: string;
        data: KinesisEventData;
      }
      ```

    </div>
  </Columns>
</Accordion>

<BlockSwitcher>
  <Block name="V6">
    ```ts
    import { record as pinpointRecord } from 'aws-amplify/analytics';
    import { record as personalizeRecord } from 'aws-amplify/analytics/personalize';
    import { record as kinesisRecord } from 'aws-amplify/analytics/kinesis';
    import { record as kinesisFirehoseRecord } from 'aws-amplify/analytics/kinesis-firehose';

    // Pinpoint
    pinpointRecord({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    personalizeRecord({
      eventType: 'Identify',
      properties: {
        userId: 'userId'
      }
    });

    // Kinesis
    kinesisRecord({
      data: {
        // The data blob to put into the record
      },
      partitionKey: 'myPartitionKey',
      streamName: 'myKinesisStream'
    });

    // Kinesis (Firehose)
    kinesisFirehoseRecord({

    });
    ```

  </Block>
  <Block name="V5">
    ```ts
    import { Analytics, AmazonPersonalizeProvider, AWSKinesisProvider, AWSKinesisFirehoseProvider } from 'aws-amplify';
    Analytics.addPluggable(new AmazonPersonalizeProvider());
    Analytics.addPluggable(new AWSKinesisProvider());
    Analytics.addPluggable(new AWSKinesisFirehoseProvider());

    // Pinpoint
    Analytics.record({
      name: 'albumVisit',
      attributes: { genre: '', artist: '' },
      metrics: { minutesListened: 30 }
    });

    // Personalize
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AmazonPersonalize');

    // Kinesis
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisProvider');

    // Kinesis (Firehose)
    Analytics.record({
      eventType: 'Identify',
      properties: {
        userId: '<USER_ID>'
      }
    }, 'AWSKinesisFirehoseProvider');

    ```

  </Block>
</BlockSwitcher>
