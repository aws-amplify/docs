import { getCustomStaticPath } from '@/utils/getCustomStaticPath';

export const meta = {
  title: 'Set up Storage',
  description: 'Set up Amplify Storage for your project',
  platforms: [
    'angular',
    'javascript',
    'nextjs',
    'react',
    'vue',
    'swift',
    'android',
    'flutter',
    'react-native'
  ]
};

export const getStaticPaths = async () => {
  return getCustomStaticPath(meta.platforms);
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };
}

<InlineFilter filters={['flutter']}>
<Callout warning>

Storage for Gen 2 is not yet available for Flutter
</Callout>
</InlineFilter>

In this guide, you will learn how to set up storage in your Amplify app. This includes setting up and connecting your backend resources and enabling file uploads, downloads, and list features.

If you have not yet created an Amplify app, visit the [quickstart guide](/[platform]/start/quickstart/).

## Building your storage backend

By defining storage in your backend configuration, you can customize the access rules to different paths in your storage bucket.

First, create a file `amplify/storage/resource.ts`. Paste the following content into the file.

```ts title="amplify/storage/resource.ts"
import { defineStorage } from '@aws-amplify/backend';

export const storage = defineStorage({
  name: 'myProjectFiles'
});
```

Then include storage in your backend definition.

```ts title="amplify/backend.ts"
import { defineBackend } from '@aws-amplify/backend';
import { auth } from './auth/resource';
// highlight-next-line
import { storage } from './storage/resource';

defineBackend({
  auth,
  // highlight-next-line
  storage
});
```

Now when you run `npx ampx sandbox` or deploy your app on Amplify, it will configure an S3 bucket where the files will be uploaded to and downloaded from.

Before files can be accessed by your application, you must configure storage access rules.

### Define File Prefix Access

By default, no users or other project resources have access to any files in the storage bucket. Access must be explicitly granted within `defineStorage` using the `access` callback.

```ts title="amplify/storage/resource.ts"
export const storage = defineStorage({
  name: 'myProjectFiles',
  access: (allow) => ({
    // highlight-next-line
    'media/photos/*': [
      // access rules that apply to all files within "/some/path/*" go here
    ],
    // highlight-next-line
    'documents/taxes/*': [
      // access rules that apply to all files within "/another/path/*" go here
    ]
  })
});
```

The access callback returns an object where each key in the object is a file prefix and each value in the object is a list of access rules that apply to that prefix. 

Refer to the following example to construct access rules for your storage bucket or you can copy paste to test it out. [Learn more about customizing access to file prefixes](/[platform]/build-a-backend/storage/authorization/).

```ts title="amplify/storage/resource.ts"
export const storage = defineStorage({
  name: 'myProjectFiles',
  access: (allow) => ({
    'authenticated_access_only/*': [
      // highlight-next-line
      allow.authenticated.to(['read', 'write', 'delete']),
    ],
    'user_protected/{entity_id}/*': [
      // highlight-next-line
      allow.authenticated.to(['read']),
      // highlight-next-line
      allow.entity('identity').to(['read', 'write', 'delete'])
    ],
    'guest_access_only/*': [
      // highlight-next-line
      allow.guest.to(['read', 'write', 'delete'])
    ]
  })
});
```
Copy and paste the following definition for authorization rules to implement public, protected, and private prefixes (this is currently the pattern in Gen 1).

```ts title="amplify/storage/resource.ts"
export const storage = defineStorage({
  name: 'myProjectFiles',
  access: (allow) => ({
    'public/*': [
      allow.guest.to(['read']),
      allow.authenticated.to(['read', 'write', 'delete']),
    ],
    'protected/{entity_id}/*': [
      allow.authenticated.to(['read']),
      allow.entity('identity').to(['read', 'write', 'delete'])
    ],
    'private/{entity_id}/*': [allow.entity('identity').to(['read', 'write', 'delete'])]
  })
});
```
## Connect your app code to the storage backend

Amplify Storage library provides client APIs that connect to the backend resources you defined.

<InlineFilter filters={["react", "angular", "javascript", "vue", "nextjs", "react-native"]}>

### Configure Amplify in project

Import and load the configuration file in your app. It's recommended you add the Amplify configuration step to your app's root entry point. For example `index.js` in React or `main.ts` in Angular.

```javascript
import { Amplify } from 'aws-amplify';
import outputs from '../amplify_outputs.json';

Amplify.configure(outputs);
```
<Callout warning="true">

Make sure you call `Amplify.configure` as early as possible in your applicationâ€™s life-cycle. A missing configuration or `NoCredentials` error is thrown if `Amplify.configure` has not been called before other Amplify JavaScript APIs.

</Callout>

</InlineFilter>

<InlineFilter filters={["swift"]}>

### Prerequisites

An application with Amplify libraries integrated and a minimum target of any of the following:
- **iOS 13.0**, using **Xcode 14.1** or later.
- **macOS 10.15**, using **Xcode 14.1** or later.
- **tvOS 13.0**, using **Xcode 14.3** or later.
- **watchOS 9.0**, using **Xcode 14.3** or later.
- **visionOS 1.0**, using **Xcode 15 beta 2** or later. (Preview support - see below for more details.)

For a full example, please follow the [project setup walkthrough](/[platform]/start/project-setup/prerequisites/).

<Callout>

visionOS support is currently in **preview** and can be used by targeting the [`visionos-preview`](https://github.com/aws-amplify/amplify-swift/tree/visionos-preview) branch. 
As new Xcode 15 beta versions are released, the branch will be updated with any necessary fixes on a best effort basis.

For more information on how to use the `visionos-preview` branch, see [Platform Support](https://github.com/aws-amplify/amplify-swift/tree/visionos-preview#platform-support).

</Callout>

### Install Amplify library via Swift Package Manager

1. To install Amplify Libraries in your application, open your project in Xcode and select **File > Add Packages...**.

2. Enter the **Amplify Library for Swift** GitHub repo URL (`https://github.com/aws-amplify/amplify-swift`) into the search bar and click **Add Package**.

  <Callout>

  **Note:** **Up to Next Major Version** should be selected from the **Dependency Rule** dropdown.

  </Callout>

3. Lastly, choose **AWSS3StoragePlugin**, **AWSCognitoAuthPlugin**, and **Amplify**. Then click **Add Package**.

### Configure Amplify in project

Initialize the Amplify Storage category by calling `Amplify.add(plugin:)`. To complete initialization call `Amplify.configure()`.

<BlockSwitcher>

<Block name="SwiftUI">

Add the following imports to the top of your `App` scene and configure Amplify in the `init`:
```swift
import Amplify
import AWSCognitoAuthPlugin
import AWSS3StoragePlugin

@main
struct MyAmplifyApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }

    init() { 
        do {
            try Amplify.add(plugin: AWSCognitoAuthPlugin())
            try Amplify.add(plugin: AWSS3StoragePlugin())
            try Amplify.configure()
            print("Amplify configured with Auth and Storage plugins")
        } catch {
            print("Failed to initialize Amplify with \(error)")
        }
    }
}
```

</Block>

<Block name="UIKit">

Add the following imports to the top of your `AppDelegate.swift` file:

```swift
import Amplify
import AWSCognitoAuthPlugin
import AWSS3StoragePlugin
```

Add the following code to the `application:didFinishLaunchingWithOptions` method:

```swift
func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
) -> Bool {
    do {
        try Amplify.add(plugin: AWSCognitoAuthPlugin())
        try Amplify.add(plugin: AWSS3StoragePlugin())
        try Amplify.configure()
        print("Amplify configured with Auth and Storage plugins")
    } catch {
        print("Failed to initialize Amplify with \(error)")
    }

    return true
}
```

</Block>

</BlockSwitcher>

Upon building and running this application you should see the following in your console window:

```console
Amplify configured with Auth and Storage plugins
```

</InlineFilter>

<InlineFilter filters={["android"]}>

### Prerequisites

* An Android application targeting Android API level 24 (Android 7.0) or above
    * For a full example of creating Android project, please follow the [project setup walkthrough](/[platform]/start/project-setup/create-application/)

### Install Amplify library

Expand **Gradle Scripts**, open **build.gradle (Module: app)**. You will already have configured Amplify by following the steps in the [Project Setup walkthrough](/[platform]/start/project-setup/create-application/).

Add these libraries into the `dependencies` block:
```groovy
dependencies {
    implementation 'com.amplifyframework:aws-storage-s3:ANDROID_VERSION'
    implementation 'com.amplifyframework:aws-auth-cognito:ANDROID_VERSION'
}
```

`aws-auth-cognito` is used to provide authentication for Amazon S3.

Click **Sync Now**.

### Configure Amplify in project

Initialize the Amplify Storage category by calling `Amplify.addPlugin()`. To complete initialization call `Amplify.configure()`.

Add the following code to your `onCreate()` method in your application class:

<BlockSwitcher>
<Block name="Java">

```java
import android.util.Log;
import com.amplifyframework.auth.cognito.AWSCognitoAuthPlugin;
import com.amplifyframework.core.Amplify;
import com.amplifyframework.storage.s3.AWSS3StoragePlugin;
```

```java
Amplify.addPlugin(new AWSCognitoAuthPlugin());
Amplify.addPlugin(new AWSS3StoragePlugin());
```

Your class will look like this:

```java
public class MyAmplifyApp extends Application {
    @Override
    public void onCreate() {
        super.onCreate();

        try {
            // Add these lines to add the AWSCognitoAuthPlugin and AWSS3StoragePlugin plugins
            Amplify.addPlugin(new AWSCognitoAuthPlugin());
            Amplify.addPlugin(new AWSS3StoragePlugin());
            Amplify.configure(getApplicationContext());

            Log.i("MyAmplifyApp", "Initialized Amplify");
        } catch (AmplifyException error) {
            Log.e("MyAmplifyApp", "Could not initialize Amplify", error);
        }
    }
}
```

</Block>
<Block name="Kotlin">

```kotlin
import android.util.Log
import com.amplifyframework.auth.cognito.AWSCognitoAuthPlugin
import com.amplifyframework.core.Amplify
import com.amplifyframework.storage.s3.AWSS3StoragePlugin
```

```kotlin
Amplify.addPlugin(AWSCognitoAuthPlugin())
Amplify.addPlugin(AWSS3StoragePlugin())
```

Your class will look like this:

```kotlin
class MyAmplifyApp : Application() {
    override fun onCreate() {
        super.onCreate()

        try {
            // Add these lines to add the AWSCognitoAuthPlugin and AWSS3StoragePlugin plugins
            Amplify.addPlugin(AWSCognitoAuthPlugin())
            Amplify.addPlugin(AWSS3StoragePlugin())
            Amplify.configure(applicationContext)

            Log.i("MyAmplifyApp", "Initialized Amplify")
        } catch (error: AmplifyException) {
            Log.e("MyAmplifyApp", "Could not initialize Amplify", error)
        }
    }
}
```

</Block>
<Block name="RxJava">

```java
import android.util.Log;
import com.amplifyframework.auth.cognito.AWSCognitoAuthPlugin;
import com.amplifyframework.rx.RxAmplify;
import com.amplifyframework.storage.s3.AWSS3StoragePlugin;
```

```java
RxAmplify.addPlugin(new AWSCognitoAuthPlugin());
RxAmplify.addPlugin(new AWSS3StoragePlugin());
```

Your class will look like this:

```java
public class MyAmplifyApp extends Application {
    @Override
    public void onCreate() {
        super.onCreate();

        try {
            // Add these lines to add the AWSCognitoAuthPlugin and AWSS3StoragePlugin plugins
            RxAmplify.addPlugin(new AWSCognitoAuthPlugin());
            RxAmplify.addPlugin(new AWSS3StoragePlugin());
            RxAmplify.configure(getApplicationContext());

            Log.i("MyAmplifyApp", "Initialized Amplify");
        } catch (AmplifyException error) {
            Log.e("MyAmplifyApp", "Could not initialize Amplify", error);
        }
    }
}
```

</Block>
</BlockSwitcher>

Note that because the storage category requires auth, you will need to either configure [guest access](/[platform]/build-a-backend/auth/enable-guest-access/) or [sign in a user](/[platform]/build-a-backend/auth/enable-sign-in/) before using features in the storage category.

</InlineFilter>

<InlineFilter filters={["flutter"]}>

### Prerequisites

* A Flutter application targeting Flutter SDK >= 3.3.0 with Amplify libraries integrated

  The following are also required, depending on which platforms you are targeting:

  * An iOS configuration targeting at least iOS 13.0 and XCode version >=13.2
  * An Android configuration targeting at least Android API level 24 (Android 7.0) or above
  * Any browser supported by Flutter for Web (you can check the list of supported browsers [here](https://docs.flutter.dev/development/platform-integration/web/faq#which-web-browsers-are-supported-by-flutter))
  * Any Windows OS meeting Flutter minimums
  * macOS version 10.15 or higher
  * Any Ubuntu Linux distribution meeting Flutter minimums
  * For a full example please follow the [project setup walkthrough](/[platform]/start/project-setup/create-application/)

### Install Amplify library

Add the following dependency to your **app**'s `pubspec.yaml` along with others you added above in **Prerequisites**:

```yaml
environment:
  sdk: ">=2.18.0 <4.0.0"
  flutter: ">=3.3.0"

dependencies:
  flutter:
    sdk: flutter

  amplify_auth_cognito: ^1.0.0
  amplify_flutter: ^1.0.0
  amplify_storage_s3: ^1.0.0
```

### Configure Amplify in project

To initialize the Amplify Auth and Storage categories, call `Amplify.addPlugin()` for each plugin or pass all the plugins in `Amplify.addPlugins()`. To complete initialization, call `Amplify.configure()`.

Your code should look like this:

```dart
import 'package:amplify_auth_cognito/amplify_auth_cognito.dart';
import 'package:amplify_flutter/amplify_flutter.dart';
import 'package:amplify_storage_s3/amplify_storage_s3.dart';
import 'package:flutter/material.dart';

import 'amplifyconfiguration.dart';

Future<void> _configureAmplify() async {
  try {
    final auth = AmplifyAuthCognito();
    final storage = AmplifyStorageS3();
    await Amplify.addPlugins([auth, storage]);

    // call Amplify.configure to use the initialized categories in your app
    await Amplify.configure(amplifyconfig);
  } on Exception catch (e) {
    safePrint('An error occurred configuring Amplify: $e');
  }
}

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await _configureAmplify();
  runApp(const MyApp());
}

class MyApp extends StatefulWidget {
  const MyApp({Key? key}) : super(key: key);

  // ...
}
```

</InlineFilter>

## Manage files in Amplify console

After successfully publishing your storage backend and connecting your project with client APIs, you can manage files and folders in [the Amplify console](https://console.aws.amazon.com/amplify). You can perform on-demand actions like upload, download, copy, and more under the Storage tab in the console.

![Showing Amplify console showing Storage tab selected](/images/gen2/storage/amplify-console-storage.png)

## Conclusion

Congratulations! You finished the Set up Amplify Storage guide. In this guide, you set up and connected to backend resources, customized your file prefixes and access definitions, and connected your application to the backend to implement features like file uploads and downloads.

### Next steps

Now that you have completed setting up storage in your Amplify app, you can proceed to add file management features to your app. You can access the following links to jump to upload and download functionality or access to more capabilities from the sidebar under storage.

- [Upload Files](/[platform]/build-a-backend/storage/upload-files/)
- [Download Files](/[platform]/build-a-backend/storage/download-files/)
