import { getCustomStaticPath } from '@/utils/getCustomStaticPath';

export const meta = {
  title: 'Configure a geofence collection',
  description: 'Create and manage collections of Geofences',
  platforms: [
    'angular',
    'javascript',
    'nextjs',
    'react',
    'vue'
  ]
};

export const getStaticPaths = async () => {
  return getCustomStaticPath(meta.platforms);
};

export function getStaticProps(context) {
  return {
    props: {
      platform: context.params.platform,
      meta
    }
  };
}

A Geofence is a virtual perimeter for a real-world geographic area. A Geofence contains points or vertices that form a closed boundary, defining an area of interest. Geofence collections store one or multiple Geofences.

## Setup a new Geofence Collection

```ts title="amplify/geo/resource.ts"
import { defineCollection } from "@aws-amplify/backend-geo";

export const collection = defineCollection({
  name: 'amplifyCollection',
  description: 'This is an Amplify collection.',
  access: (allow) => [
    allow.authenticated.to(['create', 'read', 'update', 'delete', 'list']),
    allow.guest.to(['read', 'list'])
  ]
});
```

Now update your `backend.ts` file with the collection created in your `resource.ts` file.

```ts title="amplify/backend.ts"
import { defineBackend } from "@aws-amplify/backend";
import { Policy, PolicyStatement } from "aws-cdk-lib/aws-iam";
import { CfnGeofenceCollection } from "aws-cdk-lib/aws-location";
import { auth } from "./auth/resource";
import { data } from "./data/resource";
import { collection } from "./geo/resource";

const backend = defineBackend({
  auth,
  data,
  collection
});
```

<Callout warning="true">

AWS Location API keys currently do not support geofence collections or their associated APIs. Adding access definitions for any API keys using the `allow.apiKey.to()` definition will NOT result in the creation of an API key.

</Callout>

## Configure additional geofence collections

Amplify Geo gives you the ability to configure your backend to automatically request and manage multiple geofence collections.

You can define these additional geofence collections by reusing the `defineCollection` function while providing a unique `name` to identify the collection. You can configure specific access permissions to these collections by adding them to the API with the unique `name`.

<Callout info>

**Note**: If numerous geofence collections are defined, then one of them must be marked as default using the `isDefault` flag.

</Callout>

```ts title="amplify/geo/resource.ts"
export const firstCollection = defineCollection({
  name: 'firstCollection',
  isDefault: true
});

export const secondCollection = defineCollection({
  name: 'secondCollection'
});
```

## Geofence Collection Pricing Plan

The pricing plan for the Geofence Collection will be set to `RequestBasedUsage`. We advice you to go through the [location service pricing](https://aws.amazon.com/location/pricing/) along with the [location service terms](https://aws.amazon.com/service-terms/) (_82.5 section_) to learn more about the pricing plan.

### Group access

To scope access permissions based on [Cognito User Groups](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-user-groups.html)

1. Create a Cognito User Pool Group

```ts title="amplify/auth/resource.ts"
import { defineAuth } from '@aws-amplify/backend';

export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  groups: ["User"],
});
```

2. Update the collection access definition in your `resource.ts`

```ts title="amplify/geo/resource.ts"
import { defineCollection } from "@aws-amplify/backend-geo";

export const collection = defineCollection({
  name: 'amplifyCollection',
  description: 'This is an Amplify collection.',
  access: (allow) => [
    allow.authenticated.to(['create', 'read', 'update', 'delete', 'list']),
    allow.guest.to(['read', 'list']),
    // highlight-next-line
    allow.groups("User").to(['read', 'update'])
  ]
});
```

> Note: If you combine `Auth/Guest user access` and `Individual Group access`, users who are members of a group will only be granted the permissions of the group, and not the authenticated user permissions. The permissions apply to ALL Geofences in a collection. For example, If you add `Read` permission such as `ListGeofences` and `GetGeofence` to `User` Cognito group, ALL users added to that group will be able to read the properties of ALL Geofences in that Geofence collection.

#### Using the AWS SDK for Javascript

Alternatively, if you want to add users to an existing Cognito user pool group programmatically, you can use the AWS SDK for Javascript. Refer to the [API documentation](https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CognitoIdentityServiceProvider.html#adminAddUserToGroup).



<InlineFilter filters={["javascript", "react", "angular", "nextjs", "vue"]}>

<Callout>

**Note:** After you have provisioned the Geofence Collection, depending on your application's use-case, you can also add Geofences to the provisioned Geofence Collection programmatically. Refer this [API documentation](/[platform]/build-a-backend/add-aws-services/geo/geofences/#savegeofences) for more information.

</Callout>

</InlineFilter>
