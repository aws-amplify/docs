import { getCustomStaticPath } from '@/utils/getCustomStaticPath';
import { IconGithub } from '@/components/Icons/IconGithub'
import { IconAmplify } from '@/components/Icons/IconAmplify'

export const meta = {
  title: 'Vite + React App - Option 2',
  description: 'Get started with AWS Amplify Gen 2 using Vite + React.',
  platforms: [
    'android',
    'angular',
    'flutter',
    'javascript',
    'nextjs',
    'react',
    'react-native',
    'swift',
    'vue'
  ]
};

export const getStaticPaths = async () => {
  return getCustomStaticPath(meta.platforms);
};

export function getStaticProps() {
  return {
    props: {
      meta
    }
  };
}

ðŸ‘‹ Welcome to AWS Amplify! In this quickstart guide, you will:
1. deploy a React + Vite app
2. build and connect to a database
3. configure authentication and authorization rules


## Deploy a React app to AWS Amplify

To get started faster, we've created a starter "To-do" application. First, clone this starter application into your GitHub account.

<ExternalLinkButton
  size="large"
  href='https://github.com/new?template_name=gen2-starter-option-2&template_owner=renebrandel&name=gen2-starter&description=My%20Amplify%20Gen%202%20starter%20application'
>
<IconGithub />
Use starter template
</ExternalLinkButton>

Next, go to the AWS Amplify console to deploy the application.

<ExternalLinkButton
  size="large"
  href='https://us-east-1.console.aws.amazon.com/amplify/create/repo-branch'
>
<IconAmplify />
Deploy starter template
</ExternalLinkButton>

Select **Start with an existing app** > **GitHub**, pick the starter repository, and hit "Deploy".

<video autoPlay={true} muted={true} loop={true} width="100%" playsInline={true}>
  <source src="/images/gen2/getting-started/react/deploy.mp4" />
</video>

While you wait for the build (~3 min), let's take a tour on the key files included in the starter repository:

```text
â”œâ”€â”€ src/ # React UI code
â”‚   â”œâ”€â”€ App.tsx # UI code to display todos
â”‚   â”œâ”€â”€ index.css # Styling for your app
â”‚   â””â”€â”€ main.tsx # Entrypoint for the React application
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

Once the build has completed view the newly deployed app by selecting "View production URL".

<video autoPlay={true} muted={true} loop={true} width="100%" playsInline={true}>
  <source src="/images/gen2/getting-started/react/hosted-app.mp4" />
</video>

## Setup cloud sandbox for rapid fullstack iteration

The starter application already has pre-written code to list and remove todos locally. Let's learn how to store and retrieve the todos to the cloud! We went ahead and already pre-defined your Amplify backend. Here's a quick overview of the Amplify Backend-specific files.

```text
â”œâ”€â”€ amplify/ # Folder containing your Amplify backend configuration
â”‚   â”œâ”€â”€ auth/ # Definition for your auth backend
â”‚   â”‚   â””â”€â”€ resource.ts
â”‚   â”œâ”€â”€ data/ # Definition for your data backend
â”‚   â”‚   â””â”€â”€ resource.ts
|   â”œâ”€â”€ backend.ts
â”‚   â””â”€â”€ tsconfig.json
```

### Clone the starter app code locally

First, clone your repository locally by following instructions on your GitHub repo page:

```bash title="Terminal" showLineNumbers={false}
git clone https://github.com/<github-user>/gen2-starter.git
```

Next, install all dependencies in order to run the dev environment locally.

```bash title="Terminal" showLineNumbers={false}
cd gen2-starter
npm install
```

### Initialize a cloud sandbox for your localhost frontend

<Callout info>

**First time using AWS Amplify Gen 2 on your computer?** [Configure your AWS account to grant Amplify permissions locally](/[platform]/start/account-setup/). **Note:** If you already have an AWS profile with credentials on your local machine, and you have configured the corresponding AWS profile with the **AmplifyBackendDeployFullAccess** permission policy, you can skip this step.

</Callout>

Amplify's cloud sandbox functionality creates a per-developer backend environment intended for your localhost development and testing workflows. This allows you to test and iterate without touching production backend data. 

To start your cloud sandbox, run the following command in a **new Terminal window**:

```bash title="Terminal" showLineNumbers={false}
npx amplify sandbox
```

Once the cloud sandbox has been fully deployed (~5 min), you'll see an **amplifyconfiguration.json** file created with connection information to a new isolated authentication and data backend.

<Callout info>

The `npx amplify sandbox` command should run concurrently to your `npm run dev`. You can think of the cloud sandbox as the "localhost-equivalent for your app backend".

</Callout>

## Build and connect to a database

Go to the **amplify/data/resource.ts** file. In there you'll find the definition of your backend data model. We have a `Todo` model with a `content` field. Let's replace the existing UI code that purely stores the data in a local state to use the cloud backend instead.

### Enable real-time feed of todos

Amplify Data provides a built-in capability to subscribe to a real-time feed of your data. Let's use that to update the state of the todos

```tsx
// highlight-start
import { useEffect, useState } from 'react'
import type { Schema } from '../amplify/data/resource'
import { generateClient } from "aws-amplify/data"

const client = generateClient<Schema>()
// highlight-end

function App() {
  // Updated types to use backend data model types for end-to-end safety
  // highlight-next-line
  const [todos, setTodos] = useState<Array<Schema["Todo"]>>([])

  // highlight-start
  useEffect(() => {
    client.models.Todo.observeQuery().subscribe({
      next: (data) => setTodos([...data.items])
    }) 
  }, [])
  // highlight-end

  // ...

  return (
    <main>
      {/* ... */}
    </main>
  )
}
```

### Add "create todo" functionality

Next, let's update the `createTodo` function to make an "Create" API request to our cloud backend. 

```tsx
// ...
function App() {
  // ...
  function createTodo() {
    // highlight-next-line
    client.models.Todo.create({ content: window.prompt("Todo content") })
  }

  return (
    <main>
      {/* ... */}
    </main>
  )
}
// ...
```

Try out the create and real-time list functionality now by starting the local dev server:

```bash title="Terminal" showLineNumbers={false}
npm run dev
```

This should start a local dev server at http://localhost:5173.

### Add "delete todo" functionality

Go to the **src/App.tsx** file and add in a new `deleteTodo` functionality and pass function into the `<li>` element's `onClick` handler.

```tsx title="src/App.tsx"
function App() {
  // ...
  // highlight-start
  function deleteTodo(id: string) {
    client.models.Todo.delete({ id })
  }
  // highlight-end

  return (
    <main>
      <h1>My todos</h1>
      <button onClick={createTodo}>+ new</button>
      <ul>
        {todos.map(todo => <li
          // highlight-next-line
          onClick={() => deleteTodo(todo.id)}
          key={todo.id}>
          {todo.content}
        </li>)}
      </ul> 
      <div>
        ðŸ¥³ App successfully hosted. Try creating a new todo.
        <br />
        <a href="">Review next step of this tutorial.</a>
      </div>
    </main>
  )
}
```

Try out the deletion functionality now on your localhost.

<video autoPlay={true} muted={true} loop={true} width="100%" playsInline={true}>
  <source src="/images/gen2/getting-started/react/demo-delete.mp4" />
</video>

Once everything works, push your latest changes to the Amplify-hosted URL by committing everything to git and push.

```bash title="Terminal" showLineNumbers={false}
git commit -am "added create, list, and delete functionality"
git push -u origin/main
```

Amplify automatically deploys the latest version of your app based on your git commits. In just a few minutes, when the application rebuilds, the hosted URL will be updated to support the new cloud data functionality.

## Add authentication

The starter application already has a pre-configured auth backend defined in the **amplify/auth/resource.ts** file. We've configured it to support email and password login but you can extend it to support a variety of login mechanisms, including Google, Amazon, Sign In With Apple, and Facebook.

The fastest way to get your login experience up and running is to use our Authenticator UI component. In your **src/App.tsx** file, import the Authenticator UI component and wrap your `<main>` element.

```tsx title="src/App.tsx"
// highlight-start
import { Authenticator } from '@aws-amplify/ui-react'
import '@aws-amplify/ui-react/styles.css'
// highlight-end
// ... other imports

function App() {
  // ...
  return (
    // highlight-start
    <Authenticator>
      {({ signOut, user }) => (
    // highlight-end
        <main>
          {/*...*/}
          // highlight-next-line
          <button onClick={signOut}>Sign out</button>
        </main>
      )}
    // highlight-next-line
    </Authenticator>
  )
}
```

The Authenticator component auto-detects your auth backend settings and renders the correct UI state based on the auth backend's authentication flow.

Try out your application in your localhost environment again. You should be presented with a login experience now.

<video autoPlay={true} muted={true} loop={true} width="100%" playsInline={true}>
  <source src="/images/gen2/getting-started/react/demo-auth.mp4" />
</video>

To get these changes to the cloud, commit them to git and push the changes upstream.

```bash title="Terminal" showLineNumbers={false}
git commit -am "added authenticator"
git push
```

## Configure authorization rules for your app data

The todos in the starter are currently shared across all users but in most cases you want data to be isolated on a per-user basis. 

To isolate the data on a per-user basis, you can use "owner-based authorization rule". Let's apply the owner-based authorization rule to your todos:

```ts title="amplify/data/resource.ts"
import { type ClientSchema, a, defineData } from '@aws-amplify/backend';

const schema = a.schema({
  Todo: a.model({
    content: a.string(),
    // highlight-next-line
  }).authorization([a.allow.owner()]),
});

export type Schema = ClientSchema<typeof schema>;

export const data = defineData({
  schema,
  authorizationModes: {
    // This tells the data client in your app (generateClient())
    // to sign API requests with the user authentication token. 
    // highlight-next-line
    defaultAuthorizationMode: 'userPool',
  },
});
```

In the application client code, let's also render the username to distinguish different users once they're logged in. Go to your **src/App.tsx** file and render the `user` property.

```tsx title="src/App.tsx"
// ... imports

function App() {
  // ...
  return (
    <Authenticator>
      // highlight-next-line
      {({ signOut, user }) => (
        <main>
          // highlight-next-line
          <h1>{user?.signInDetails?.loginId}'s todos</h1>
          {/* ... rest of the UI */}
        </main>
      )}
    </Authenticator>
  )
}
```

Now, let's go back to your localhost application and test out the user isolation of the todos. 

<video autoPlay={true} muted={true} loop={true} width="100%" playsInline={true}>
  <source src="/images/gen2/getting-started/react/demo-auth.mp4" />
</video>

To get these changes to the cloud, commit them to git and push the changes upstream.

```bash title="Terminal" showLineNumbers={false}
git commit -am "added per-user data isolation"
git push
```

Once your build completes in Amplify Hosting, the production backend will update to support the changes made within the cloud sandbox. The data in the cloud sandbox is fully isolated and won't pollute your production database.

## ðŸ¥³ Success

That's it! You have successfully deployed your fullstack app on AWS Amplify. Here are a few next steps we encourage you to check out:
- Iterating on your data model
- Add social providers to authentication backend
- Add cloud file storage to your app
- Create custom API endpoints
- Create a real-time PubSub API
- ...
