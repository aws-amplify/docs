import { getCustomStaticPath } from '@/utils/getCustomStaticPath';

export const meta = {
  title: 'Migrate to Gen 2',
  description: 'Learn how to set up your AWS account and configure it locally for use with Amplify.',
  platforms: [
    'android',
    'angular',
    'flutter',
    'javascript',
    'nextjs',
    'react',
    'react-native',
    'swift',
    'vue'
  ]
};

export function getStaticPaths () {
  return getCustomStaticPath(meta.platforms);
}

export function getStaticProps(context) {
  return {
    props: {
      platform: context.params.platform,
      meta
    }
  };
}

## Starting point

My app

- main branch --> prod BE
- dev branch ---> dev BE
- custom domain setup
  - main.myapp.com and dev.myapp.com

## Set up migration environment

1. git clone my-app
2. git checkout -b migrate-to-gen2
3. amplify init --envName prod to initialize the app locally
4. amplify env add --envName migrate to create a temporary migration env
   1. this should prompt for any OAuth credentials, Function env vars, secrets, etc.
5. amplify push to create the new environment
6. deploy `migrate-to-gen2` branch in Console and connect it to `migrate` env.
7. amplify migrate to initiate the migration

## Generate Gen 2 codegen

```console title="Terminal" showLineNumbers={false}
> amplify migrate
You are about to migrate to Amplify Gen 2: <Docs URL>
✓ Move project/amplify to project/.amplify/gen-1
✓ Transforming your auth and data backend definition to Gen 2 configuration:
   ✔ amplify/auth/resource.ts
   ✔ amplify/data/resource.ts
✔ Updating .gitignore to remove Gen1 files
✔ Update package.json with Gen 2 dependencies
   ✔ Installing @aws-amplify/backend
   ✔ Installing @aws-amplify/backend-cli

Run `npx ampx sandbox` to test whether your Gen 2 backend works.
```

## Test whether Gen2 codegen works as expected in sandbox

```console title="Terminal" showLineNumbers={false}
> npx ampx sandbox

# starts a cloudformation deploy

# new tab
> npm run dev

# starts localhost

```

optionally run validation tool to compare resource configurations from live Gen 1 stack to CFN artifacts from Gen 2 synth

Now let's add an `amplify.yml` to your project. If you already have a YAML stored in the Console, go to the console and download the file and add it to the root of your project. Update the amplify.yml to look like

```diff title="amplify.yml"
version: 1
backend:
  phases:
    build:
      commands:
-       - "# Execute Amplify CLI with the helper script"
-       - amplifyPush --simple
+       - npm ci
+       - npx ampx pipeline-deploy --app-id $AWS_APP_ID --branch $AWS_BRANCH
frontend:
  phases:
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
```

## Now deploy the migrate-to-gen2 branch

First push this code to a Git branch

```bash title="Terminal" showLineNumbers={false}
git add .
git commit -m "migrate to gen2"
git push -u origin migrate-to-gen2
```

Now deploy the `migrate-to-gen2` branch in the Amplify Console as a new branch in the Gen 2 console. Now you should see:

- main branch --> prod BE
- dev branch ---> dev BE
- migrate-to-gen2 branch (gen2 stack) --> migrate BE (Gen 1 CF stack)

- custom domain setup
  - main.myapp.com and dev.myapp.com and migrate-to-gen2.myapp.com (with autosubdomains enabled)

Remove backend assooication between migrate-to-gen2 branch (gen2 stack) --> migrate BE (Gen 1 CF stack)
Now you have a Gen 1 backend environment called "migrate" and a Gen 2 branch called "migrate-to-gen2". Go back to your terminal and execute:

```bash title="Terminal" showLineNumbers={false}
# some command to generate the logical ID mapping, and any other prep
amplify migrate --generate-mapping --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
# this --continue can error if we don't have gen 2 artifacts
```

```bash title="Terminal" showLineNumbers={false}
# validate resource configurations between the stacks match
amplify migrate --compare auth --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
amplify migrate --compare auth,data,storage --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
```

```bash title="Terminal" showLineNumbers={false}
# some command to execute CFN stack refactoring with map
amplify migrate --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
```

## Apply changes to real environments

1. Remove backend association in console

1. Locally checkout branch you want to migrate

```bash title="Terminal" showLineNumbers={false}
git checkout dev #apply to whatever branch

git merge migrate-to-gen2 -X theirs

git push
```

```bash title="Terminal" showLineNumbers={false}
# some command to generate the logical ID mapping, and any other prep
amplify migrate --generate-mapping --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
# this --continue can error if we don't have gen 2 artifacts
```

```bash title="Terminal" showLineNumbers={false}
# validate resource configurations between the stacks match
amplify migrate --compare auth --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
amplify migrate --compare auth,data,storage --from amplifymigratesoemgen1stackname --to amplify-gen1togen2-branch-12345
```

---

If anything fails in the flow above, customers can always run `git reset --hard HEAD` and they are back to Gen 2.

1.  this prints a message about migrating to gen 2, including a link to migration docs
2.  this moves amplify/ to .amplify/gen-1 (this shouldn't be impacted by subsequent gen2 deployments)
3.  this codegen's gen2 backend resources — Auth, Data, Storage, Function resources
4.  this modifies gitignore, removes Gen 1 gitignore block, adds Gen 2 gitignore (e.g. .amplify/)
    1. print diff and prompt for confirmation
5.  this installs gen 2 tooling with package manager of choice
    1. print list of dependencies and prompt for confirmation
    2. Note: Gen 1 CLI does not have this detection built in, however we can always prompt with a list of package managers
    3. (see create-amplify for list of dependencies https://github.com/aws-amplify/amplify-backend/blob/main/packages/create-amplify/src/amplify_project_creator.ts#L15-L26)
6.  this writes amplify.yml with the default gen 2 template
    1. print diff and prompt for confirmation
    2. how do we handle existing, customized yml files?
    3. how do we handle complex frontend builds? should this get carried from the existing file?
7.  this prepares any artifacts needed for stack refactoring
    1. print a notice
    2. do we need to deploy gen 2 first?
8.  customer confirms changes by manually inspecting generated outputs, then commits to git
9.  ...

## Feature matrix

The tables below present a feature matrix for Gen 1 customers who are considering Gen 2 for their apps. This will help determine the support availability for various features.

### Auth

| Feature | Gen 1 | Gen 2 |
|---|---|---| 
| Configure username | Yes | Yes with CDK |
| Configure email | Yes | Yes |
| Configure phone number | Yes | Yes |
| Facebook | Yes | Yes |
| Google | Yes | Yes |
| Amazon | Yes | Yes |
| Sign-in with Apple | Yes | Yes |
| Add user pool groups | Yes | Yes |
| User pool group preference | Yes | Yes |
| Email verification link redirect | Yes | Yes |
| Sign-up attributes | Yes | Yes |
| Auth trigger support | Yes | Yes |
| Auth trigger templates: Add Google reCaptcha Challenge | Yes | Yes |
| Auth trigger templates: Add user to Group | Yes | Yes |
| Auth trigger templates: Email Domain Filtering (denylist) | Yes | Yes |
| Auth trigger templates: Email Domain Filtering (allowlist) | Yes | Yes |
| Auth trigger templates: Override ID Token Claims | Yes | Yes |
| Auth trigger templates: Custom Auth Challenge Flow| Yes | No |
| Configure default password policy | Yes | Yes with CDK |
| Configure read/write capabilities for attributes | Yes | Yes with CDK |
| Oauth flow: Configure authorization v implicit grant | Yes | Yes with CDK |
| Admin queries | Yes | Yes with CDK |
| MFA login (on/off/optional) | Yes | Yes |
| MFA: SMS | Yes | Yes |
| MFA: TOTP | Yes | Yes |
| Zero-config Authenticator support | Yes | Yes |
| User management in console | Yes | Yes |
| Configure Oauth scopes | Yes | Yes |
| Email verification - code | Yes | Yes |
| Email Verification - Link | Yes | Yes |
| Oauth flow: Configure redirect URIs | Yes | Yes |
| Ability to set a friendly name for User Pool | Yes | Yes |
| Unauthenticated logins | Yes | Yes |
| Custom attributes | Yes | Yes with CDK |
| Oauth flow: Configure domain name prefix | Yes | Yes with CDK |
| Auth configuration in console | Yes | No |
| First class OIDC support | No | Yes |
| First class SAML support | No | Yes |
| Import auth | Yes | No |

### Data

| Feature | Gen 1 | Gen2 |
|---|---|---|
| model | Yes | Yes |
| primaryKey | Yes | Yes |
| secondaryKey (name, sortKeyFields, query) | Yes | Yes |
| hasOne | Yes | Yes |
| hasMany | Yes | Yes |
| belongsTo | Yes | Yes |
| manyToMany | Yes | Yes |
| default | Yes | Yes |
| **auth - model level** |   |   |
| auth - public - apiKey | Yes | Yes |
| auth - public - iam | Yes | Yes |
| auth - owner - userPools | Yes | Yes |
| auth - owner - ownerField - userPools | Yes | Yes |
| auth - owner - ownerField as array - userPools | Yes | Yes |
| auth - owner - oidc | Yes | Yes |
| auth - owner - ownerField - oidc | Yes | Yes |
| auth - owner - ownerField as array - oidc | Yes | Yes |
| auth - private - userPools | Yes | Yes |
| auth - private - oidc | Yes | Yes |
| auth - private - iam | Yes | Yes |
| auth - group - userPools | Yes | Yes |
| auth - group - dynamic - userPools | Yes | Yes |
| auth - group - oidc | Yes | Yes |
| auth - group - dynamic - oidc | Yes | Yes |
| auth - custom - function | Yes | Yes |
| **auth - field level** |   |   |
| auth - public - apiKey | Yes | Yes |
| auth - public - iam | Yes | Yes |
| auth - owner - userPools | Yes | Yes |
| auth - owner - ownerField - userPools | Yes | Yes |
| auth - owner - ownerField as array - userPools | Yes | Yes |
| auth - owner - oidc | Yes | Yes |
| auth - owner - ownerField - oidc | Yes | Yes |
| auth - owner - ownerField as array - oidc | Yes | Yes |
| auth - private - userPools | Yes | Yes |
| auth - private - oidc | Yes | Yes |
| auth - private - iam | Yes | Yes |
| auth - group - userPools | Yes | Yes |
| auth - group - dynamic - userPools | Yes | Yes |
| auth - group - oidc | Yes | Yes |
| auth - group - dynamic - oidc | Yes | Yes |
| auth - custom - function | Yes | Yes |
| **other directives** |   |   |
| searchable | Yes | No but we offer a guide using Zero-ETL DynamoDB-to-OpenSearch |
| predictions | Yes | No but we offer a guide with AI service integrations |
| **Custom Mutations, Queries, Subscriptions** | Yes | Yes |
| VTL handler | Yes | Yes with CDK |
| JavaScript resolver handler | No | Yes |
| function handler | Yes | Yes |
| http handler | Yes | Yes - we support custom data sources including `http` |
| **Other configurations** |  |  |
| DataStore support | Yes | No but we'll offer a migration guide soon |
| Visual configuration | Yes | No - Gen 2 is code-first by design |
| @model queries, mutations, subscriptions, and timestamps modifiers | Yes | No |
| Custom GraphQL Transformer plugins | Yes | No |
| MySQL and PostgreSQL support | No | Yes |
| In-IDE end-to-end type safety | No | Yes |

### Storage

| Feature | Gen 1 | Gen 2 |
|---|---|---|
| Ability to provision S3 bucket | Yes | Yes |
| Auth and Guest access | Yes | [Yes](/[platform]/build-a-backend/storage/authorization/#for-gen-1-public-protected-and-private-access-pattern) |
| Auth - Configure CRUD access | Yes | Yes |
| Configure Cognito Group CRUD access | Yes | Yes |
| Guest - Configure CRUD access | Yes | Yes |
| Lambda trigger for S3 bucket | Yes | Yes |
| Import an S3 bucket | Yes | Yes |
| File browser in console | Yes | Yes |
| Ability to override/custom | Yes | Yes |
| S3 Lambda triggers | Yes | Yes |
| Locally test  | Yes | Yes - with sandbox environments |
| Visual configuration | Yes | No - Gen 2 is code-first by design |
| File Browser in console | Yes | Yes |
| Import S3 buckets | Yes | No |


### Functions

| Feature | Gen 1 | Gen 2 |
|---|---|---|
| Function runtime: TypeScript | No | Yes |
| Function resource access permissions: auth | Yes | Yes |
| Function resource access permissions: function | Yes | Yes |
| Function resource access permissions: API | Yes | Yes |
| Function resource access permissions CRUD operations | Yes | Yes |
| Function resource access permissions: custom | No | Yes |
| Environment variables | Yes | Yes |
| Secrets | Yes | Yes |
| Cron jobs | Yes | Yes |
| Configure memory size | Yes | Yes |
| Function build options for Node.js | Yes | Yes |
| Function templates: AWS AppSync - GraphQL API request (with IAM) | Yes | Yes |
| Function templates: CRUD function for DynamoDB (Integration with API Gateway) | Yes | Yes |
| Function templates: GraphQL Lambda Authorizer | Yes | Yes |
| Function templates: Hello World | Yes | Yes |
| Function templates: Lambda trigger | Yes | Yes |
| Function logs in console | Yes | Yes |
| Function resource access permissions: geo | Yes | Yes with CDK |
| Function resource access permissions: analytics | Yes | Yes with CDK |
| Function runtime: .NET 6 | Yes | Yes with CDK |
| Function runtime: Go | Yes | Yes with CDK |
| Function runtime: Java | Yes | Yes with CDK |
| Function runtime: JavaScript | Yes | Yes with CDK |
| Function runtime: Python | Yes | Yes with CDK |
| Lambda layers | Yes | No |


### Other categories

<InlineFilter filters={['android', 'swift']}>

| Feature | Gen 1 | Gen 2 |
|---|---|---| 
| REST API| Yes|	No
| Analytics| Yes|	Yes with custom CDK
| Geo| Yes|	Yes with custom CDK
| Predictions | Yes|	No
| Interactions| Yes|	No

</InlineFilter>

<InlineFilter filters={['flutter']}>

| Feature | Gen 1 | Gen 2 |
|---|---|---| 
| REST API| Yes|	Yes with custom CDK
| Analytics| Yes|	Yes with custom CDK
| Geo| No|	No
| Predictions | No|	No
| Interactions| No|	No

</InlineFilter>

<InlineFilter filters={['angular','javascript','nextjs','react','react-native','vue']}>

| Feature | Gen 1 | Gen 2 |
|---|---|---| 
| REST API| Yes|	Yes with custom CDK
| Analytics| Yes|	Yes with custom CDK
| Geo| Yes|	Yes with custom CDK
| Predictions | Yes|	Yes with custom CDK
| Interactions| Yes|	Yes with custom CDK

</InlineFilter>


