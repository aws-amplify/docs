export const meta = {
  title: 'Next.js App Router (Client Components)',
  description: 'Get started with AWS Amplify (Gen 2) using the Next.js App Router.'
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };
}

This Quickstart guide will walk you through how to build a task list application with TypeScript, Next.js **App Router with Client Components**, and React. If you are new to these technologies, we recommend you go through the official [React](https://react.dev/learn/tutorial-tic-tac-toe), [Next.js](https://nextjs.org/docs/getting-started/installation), and [TypeScript](https://www.typescriptlang.org/docs/handbook/typescript-from-scratch.html) tutorials first.

import prerequisites from 'src/fragments/gen2/quickstart/prerequisites.mdx';

<Fragments fragments={{ javascript: prerequisites, nextjs: prerequisites }} />

import createProject from 'src/fragments/gen2/quickstart/create-nextjs-app-router-project.mdx';

<Fragments fragments={{ javascript: createProject, nextjs: createProject }} />

import createAmplify from 'src/fragments/gen2/quickstart/create-amplify.mdx';

<Fragments fragments={{ javascript: createAmplify, nextjs: createAmplify}} />

import buildABackend from 'src/fragments/gen2/quickstart/build-a-backend.mdx';

<Fragments fragments={{ javascript: buildABackend, nextjs: buildABackend }} />


## Build UI

Let's add UI that connects to the backend data and auth resources.

### Add a login form

First, install the Amplify UI component library:

```bash
npm install @aws-amplify/ui-react
```

Next, create a `components` folder in the root of your project and the contents below to a file called `ConfigureAmplify.tsx`.

```ts title="components/ConfigureAmplify.tsx"
// components/ConfigureAmplify.tsx
"use client";

import config from "@/amplifyconfiguration.json";
import { Amplify } from "aws-amplify";

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
  return null;
}
```

Update `app/layout.tsx` to import and render `<ConfigureAmplifyClientSide />`.  This client component will configure Amplify for client pages in our application.

```ts title="app/layout.tsx"
// app/layout.tsx
import ConfigureAmplifyClientSide from "@/components/ConfigureAmplify";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <ConfigureAmplifyClientSide />
        {children}
      </body>
    </html>
  );
}
```

In `app/page.tsx`, update with the following code which import Amplify UI and wraps your App in the `withAuthenticator` function:

```ts title="app/page.tsx"
// app/page.tsx
"use client";

import { withAuthenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

function App() {
  return (
    <>
      <h1>Hello, Amplify ðŸ‘‹</h1>
    </>
  );
}

export default withAuthenticator(App);
```

Run your application with `npm run dev` and navigate to `http://localhost:3000`. You should now see the authenticator, which is already configured and ready for your first sign-up! Create a new user account, confirm the account through email, and then sign in.

### View list of to-do items

Now, let's display data on our app's frontend. In the `components` directory create a `TodoList.tsx` file within it with the following code:

```tsx title="components/TodoList.tsx"
// components/TodoList.tsx
"use client";

import { useState, useEffect } from "react";
import { generateClient } from "aws-amplify/data";
import type { Schema } from "@/amplify/data/resource";

// generate your data client using the Schema from your backend
const client = generateClient<Schema>();

export default function TodoList() {
  const [todos, setTodos] = useState<Schema["Todo"][]>([]);

  async function listTodos() {
    // fetch all todos
    const { data } = await client.models.Todo.list();
    setTodos(data);
  }

  useEffect(() => {
    listTodos();
  }, []);

  return (
    <div>
      <h1>Todos</h1>
      <ul>
        {todos.map((todo) => (
          <li key={todo.id}>{todo.content}</li>
        ))}
      </ul>
    </div>
  );
}
```

In `app/page.tsx`, import `components/TodoList` and render it:

```ts title="app/page.tsx"
// app/page.tsx
"use client";

import { withAuthenticator } from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";
import TodoList from "@/components/TodoList";

function App() {
  return (
    <>
      <h1>Hello, Amplify ðŸ‘‹</h1>
      <TodoList />
    </>
  );
}

export default withAuthenticator(App);
```

Once you save the file and navigate back to `http://localhost:3000`, you should see a blank page for now because you have only an empty list of to-dos.

### Create a new to-do item

Let's update the return statement of the `components/TodoList` component to have a button for creating a new to-do list item, prompting the user to add the title and description. In a production app, you would want to create a full form, and run the create method on form submission.

```tsx title="components/TodoList.tsx"
// components/TodoList.tsx
// ...
  return (
    <div>
      <h1>Todos</h1>
      <button onClick={async () => {
        // create a new Todo with the following attributes
        const { errors, data: newTodo } = await client.models.Todo.create({
          // prompt the user to enter the title
          content: window.prompt("title"),
          done: false,
          priority: 'medium'
        })
        console.log(errors, newTodo);
      }}>Create </button>

      <ul>
        {todos.map((todo) => (
          <li key={todo.id}>{todo.content}</li>
        ))}
      </ul>
    </div>
  );
}
```

Create a couple of to-dos, then refresh the page to see them. You can also subscribe to new to-dos in your `useEffect` to have them live reload on the page.

```js
useEffect(() => {
  const sub = client.models.Todo.observeQuery().subscribe(({ items }) =>
   setTodos([...items])
  );

  return () => sub.unsubscribe();
}, []);
```

### Terminate dev server

Go to `localhost` in the browser to make sure you can now log in and create and list to-dos. You can end your development session by shutting down the frontend dev server and cloud sandbox. The sandbox prompts you to delete your backend resources. While you can retain your backend, we recommend deleting all resources so you can start clean again next time.

import deployAndHost from 'src/fragments/gen2/quickstart/deploy-and-host.mdx';

<Fragments fragments={{ javascript: deployAndHost, nextjs: deployAndHost }} />
