export const meta = {
  title: 'Next.js App Router (Server Components)',
  description: 'Get started with AWS Amplify (Gen 2) using the Next.js App Router using Server Components.'
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };
}

This Quickstart guide will walk you through how to build a task list application with TypeScript, Next.js **App Router with Server Components**, and React. If you are new to these technologies, we recommend you go through the official [React](https://react.dev/learn/tutorial-tic-tac-toe), [Next.js](https://nextjs.org/docs/getting-started/installation), and [TypeScript](https://www.typescriptlang.org/docs/handbook/typescript-from-scratch.html) tutorials first.

import prerequisites from 'src/fragments/gen2/quickstart/prerequisites.mdx';

<Fragments fragments={{ javascript: prerequisites, nextjs: prerequisites }} />

import createProject from 'src/fragments/gen2/quickstart/create-nextjs-project.mdx';

<Fragments fragments={{ javascript: createProject, nextjs: createProject }} />

import buildABackend from 'src/fragments/gen2/quickstart/build-a-backend.mdx';

<Fragments fragments={{ javascript: buildABackend, nextjs: buildABackend }} />


## Build UI

Let's add UI that connects to the backend data and auth resources.


### Configure Amplify Client Side

First, install the Amplify UI component library:

```bash
npm install @aws-amplify/ui-react
```

Next, create a `components` folder in the root of your project and the contents below to a file called `ConfigureAmplify.tsx`.

```ts title="components/ConfigureAmplify.tsx"
// components/ConfigureAmplify.tsx
"use client";

import config from "@/amplifyconfiguration.json";
import { Amplify } from "aws-amplify";

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
  return null;
}
```

Update `app/layout.tsx` to import and render `<ConfigureAmplifyClientSide />`.  This client component will configure Amplify for client pages in our application.

```ts title="app/layout.tsx"
// app/layout.tsx
import ConfigureAmplifyClientSide from "@/components/ConfigureAmplify";
import "@aws-amplify/ui-react/styles.css";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <ConfigureAmplifyClientSide />
        {children}
      </body>
    </html>
  );
}
```

### Add a login page

Create a new route under `app/login/page.tsx` to render the [Amplify Authenticator component](https://ui.docs.amplify.aws/react/connected-components/authenticator) when a user is not logged in or redirect to the root route.

```ts title="app/login/page.tsx"
// app/login/page.tsx

"use client";

import { withAuthenticator } from "@aws-amplify/ui-react";
import { redirect } from "next/navigation";
import { useEffect } from "react";

function Login() {
  useEffect(() => {
    redirect("/");
  }, []);
  return null;
}

export default withAuthenticator(Login);
```

### Configure Amplify Client Side


```ts title="utils/amplify-utils.ts"
// utils/amplify-utils.ts
import { type Schema } from "@/amplify/data/resource";
import config from "@/amplifyconfiguration.json";
import { createServerRunner } from "@aws-amplify/adapter-nextjs";
import { generateServerClientUsingCookies } from "@aws-amplify/adapter-nextjs/api";
import { cookies } from "next/headers";

export const { runWithAmplifyServerContext } = createServerRunner({
  config,
});

export const cookiesClient = generateServerClientUsingCookies<Schema>({
  config,
  cookies,
});
```

### Add middleware for server-side redirect

Create `middleware.ts` in the root of the project with the contents below to redirect to `/login` when a user is not logged in.

```ts title="middleware.ts"
// middleware.ts

import { runWithAmplifyServerContext } from "@/utils/amplify-utils";
import { fetchAuthSession } from "aws-amplify/auth/server";
import { NextRequest, NextResponse } from "next/server";
//import * as mutations from '@/mutations';

export async function middleware(request: NextRequest) {
  const response = NextResponse.next();

  const authenticated = await runWithAmplifyServerContext({
    nextServerContext: { request, response },
    operation: async (contextSpec) => {
      try {
        const session = await fetchAuthSession(contextSpec, {});
        // reqResClient.graphql(contextSpec, {
        //   query: mutations.createPost,
        //   variables: {
        //     input: {
        //       body: "hello from Middleware",
        //       link: "https://google.com",
        //       title: "Hello from Middleware. Called at: " + Date.now().toLocaleString()
        //     }
        //   },
        //   authMode: 'userPool'
        // })
        return session.tokens !== undefined;
      } catch (error) {
        console.log(error);
        return false;
      }
    },
  });

  if (authenticated) {
    console.log("request.url", request.url);
    return response;
  }

  return NextResponse.redirect(new URL("/login", request.url));
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    "/((?!api|_next/static|_next/image|favicon.ico|login).*)",
  ],
};
```


Run your application with `npm run dev` and navigate to `http://localhost:3000`. You should now see the authenticator, which is already configured and ready for your first sign-up! Create a new user account, confirm the account through email, and then sign in.




### Terminate dev server

Go to `localhost` in the browser to make sure you can now log in and create and list to-dos. You can end your development session by shutting down the frontend dev server and cloud sandbox. The sandbox prompts you to delete your backend resources. While you can retain your backend, we recommend deleting all resources so you can start clean again next time.

import deployAndHost from 'src/fragments/gen2/quickstart/deploy-and-host.mdx';

<Fragments fragments={{ javascript: deployAndHost, nextjs: deployAndHost }} />
