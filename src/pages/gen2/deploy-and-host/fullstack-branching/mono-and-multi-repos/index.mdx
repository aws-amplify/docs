export const meta = {
  title: 'Separate frontend and backend teams',
  description:
    'Learn how to setup multiple repositories with the Amplify CI/CD pipeline.'
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };

}

You might have a different frontend and backend team that maintains their own repositories. Amplify Gen 2 now offers the ability of deploying repositories that have backend-only code. So frontend and backend teams can operate independently of each other.

## Deploy the backend app

1. Run `mkdir backend-app && npm create amplify@latest` to set up a backend-only Amplify project. Commit the code to a Git provider of your choice.

1. Connect the `backend-app` in the new console. Navigate to the Amplify console and select _New app > Build an app (Gen 2)_.

1. When you connect the repository, notice the only auto-detected framework is Amplify.

![multirepo](/images/gen2/fullstack-branching/multirepo1.png)

4. Once you hit _Save and deploy_, your backend project will build.

## Deploy the frontend app

1. Now lets set up the frontend app and connect to the deployed backend.

```
npm create next-app@14 -- multi-repo-example --typescript --eslint --no-app --no-src-dir --no-tailwind --import-alias '@/*'

```

2. Install Amplify dependencies.

```
cd multi-repo-example
npm add @aws-amplify/backend-cli aws-amplify @aws-amplify/ui-rect
```

3. To connect to the deployed backend run the following command. The `app-id` to reference is the `APPID` for your backend app. You can find this by going to the Amplify console and navigating to _backend-app > App settings > App ARN_ and copying the ID located at the end of the string `arn:aws:amplify:<region>:<account-id>:apps/app-id`.

```
npx amplify generate config --branch main --app-id BACKEND-APPID
```

This will generate the `amplifyconfiguration.json` file that contains all the information about your backend at the root of your project.

<img
  src="/images/gen2/fullstack-branching/multirepo3.png"
  alt="multirepo"
  width="300"
/>

4. To validate that your frontend can connect to the backend, add the `Authenticator` login form to your app.

```ts
// pages/_app.tsx
import { withAuthenticator } from '@aws-amplify/ui-react';
import { Amplify } from 'aws-amplify';
import config from '@/amplifyconfiguration.json';
import '@aws-amplify/ui-react/styles.css';
import '@/styles/globals.css';
import type { AppProps } from 'next/app';

// configure the Amplify client library with the configuration generated by `amplify sandbox`
Amplify.configure(config);

function App({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />;
}

export default withAuthenticator(App);
```

4. Let's also add an `amplify.yml` build-spec to our repository.

```yaml
version: 1
backend:
  phases:
    build:
      commands:
        - nvm use 18
        - npm ci
        - npx amplify generate config --branch main --app-id BACKEND-APPID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```

4. Now lets deploy the app in the Amplify Console, choose _New app > Build an app (Gen 2)_. Connect the repository and leave the default settings. You should see the build generates the config and does not deploy a frontend. Validate that your app is working fine.

![multi-repo](/images/gen2/fullstack-branching/multirepo4.png)

## Trigger a frontend build on backend updates

What you ideally want is for the frontend to pick up the latest backend updates every time there is a modification.

1. Use the AWS CLI to create an [incoming webhook](https://docs.aws.amazon.com/amplify/latest/userguide/webhooks.html). If the command executes successfully, you should see a response printed out like below:

```
aws amplify create-webhook --app-id FRONTEND-APPID --branch-name main  --region REGION
{
    "webhook": {
        "webhookArn": "arn:aws:amplify:REGION:ACCOUNT-ID:apps/APPID/webhooks/WEBHOOK-ID",
        "webhookId": "WEBHOOK-ID",
        "webhookUrl": "https://webhooks.amplify.ca-central-1.amazonaws.com/prod/webhooks?id=WEBHOOK-ID&token=TOKEN",
        "branchName": "main",
        "createTime": "2023-11-19T19:09:42.461000-08:00",
        "updateTime": "2023-11-19T19:09:42.461000-08:00"
    }
}
```

1. Construct a `curl` command with the `webhookUrl`: `curl -X POST -d {} "https://webhooks.amplify.ca-central-1.amazonaws.com/prod/webhooks?id=WEBHOOK-ID&token=TOKEN&operation=startbuild" -H "Content-Type:application/json`

1. Now update the `backend-app`'s build settings to include the `curl` command to trigger a frontend build any time there are changes to the backend.

``` yaml
version: 1
backend:
  phases:
    build:
      commands:
        - nvm use 18
        - npm ci
        - npx amplify pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - mkdir ./dist && touch ./dist/index.html
        - curl -X POST -d {} "https://webhooks.amplify.ca-central-1.amazonaws.com/prod/webhooks?id=WEBHOOK-ID&token=TOKEN&operation=startbuild" -H "Content-Type:application/json"
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
```
