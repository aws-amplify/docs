export const meta = {
  title: 'Auth Triggers',
  description: 'Learn how to create pre-sign up, or post-sign up handlers with Amplify (Gen 2) Auth'
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };
}

<Callout info>

**Coming soon:** The Functions experience in Amplify (Gen 2) is still under development. Expect the API surface to change dramatically during the Gen 2 preview period. If you have any feedback on the desired developer experience, please [file a GitHub issue](https://github.com/aws-amplify/amplify-backend/issues).

</Callout>

[Amazon Cognito Triggers](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools-working-with-aws-lambda-triggers.html) enable you to customize authentication flows using [AWS Lambda](https://aws.amazon.com/lambda/) functions. Customizations such as allowlisting email domains or creating a `UserProfile` model after sign-up can be written to fit your needs.

If you have not yet created an Amplify (Gen 2) app, visit the [quickstart](/gen2/start/quickstart).

## Creating your first trigger

To get started with your first trigger, create a file at `amplify/auth/pre-signup/index.js` with the following contents:

```js title="amplify/auth/pre-signup/index.js"
// amplify/auth/pre-signup/index.js
/**
 * My pre-signup trigger
 * @type {import('aws-lambda').PreSignUpTriggerHandler}
 */
exports.handler = async (event) => {
  console.log('event: ', JSON.stringify(event))
  return event
}
```

<Callout info>

This snippet includes JSDoc to type the function, including its event and return type. Install the [`@types/aws-lambda`](https://www.npmjs.com/package/@types/aws-lambda) package by using the following command:

```bash
npm add --save-dev @types/aws-lambda
```

</Callout>

Then, using the experimental `Func` module, configure your authentication resource to use the newly-created trigger file:

```ts title="amplify/auth/resource.ts"
// amplify/auth/resource.ts
import { defineAuth, Func } from '@aws-amplify/backend'

export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  triggers: {
    // use `Func.fromDir` to use the relative directory of the created trigger
    preSignUp: Func.fromDir({
      name: 'pre-signup',
      codePath: './pre-signup',
    }),
  },
})
```

`Func.fromDir` enables you to author Functions in any runtime by specifying an optional `runtime` property. For example, if you have a Python function specify the Python runtime from the [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/):

```diff title="amplify/auth/resource.ts"
// amplify/auth/resource.ts
+import { Runtime } from 'aws-cdk-lib/aws-lambda'
import { defineAuth, Func } from '@aws-amplify/backend'

export const auth = defineAuth({
  loginWith: {
    email: true,
  },
  triggers: {
    // use `Func.fromDir` to use the relative directory of the created trigger
    preSignUp: Func.fromDir({
      name: 'pre-signup',
      codePath: './pre-signup',
+     runtime: Runtime.PYTHON_3_9,
    }),
  },
})
```

## Creating custom Cognito Triggers using CDK

To author custom Functions you can use the [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/). To get started, install the CDK library package:

```bash
npm add --save-dev aws-cdk-lib
```

<Callout warning>

Depending on the Node.js package manager you are using, you may encounter warnings where it is now unable to resolve the peer dependency version `@aws-amplify/backend` has on `aws-cdk-lib`. If you encounter a warning similar to the following, re-install the version specified in the warning text:

```
npm WARN Could not resolve dependency:
npm WARN peer aws-cdk-lib@"~2.103.0" from @aws-amplify/backend@0.4.0
npm WARN node_modules/@aws-amplify/backend
npm WARN   dev @aws-amplify/backend@"^0.4.0" from the root project
```

Using the sample warning text above, you would need to install `aws-cdk-lib@2.103.0`.

</Callout>

You can use CDK's [`NodejsFunction` construct](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.html) to create the Function definition, and apply to the Amplify-generated Amazon Cognito resource as a Cognito Trigger. This is made possible via the L2 [`UserPool` construct and its provided `.addTrigger()` method](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cognito.UserPool.html#addwbrtriggeroperation-fn).

First, create the trigger's shell of a Function handler by creating a file at `amplify/custom/post-confirmation.ts` with the following contents:

```ts title="amplify/custom/post-confirmation.ts"
import type { PostConfirmationTriggerHandler } from 'aws-lambda';

export const handler: PostConfirmationTriggerHandler = async (event) => {
  console.log('event: ', JSON.stringify(event));
};
```

Next, create the instance of `NodejsFunction` using the scaffolding below, and use the `.addTrigger()` method to set the Function on your Amazon Cognito resource.

```ts title="amplify/backend.ts"
import * as url from 'node:url';
import * as cognito from 'aws-cdk-lib/aws-cognito';
import * as lambda from 'aws-cdk-lib/aws-lambda-nodejs';
import { defineBackend } from '@aws-amplify/backend';
import { auth } from './auth/resource.js';
import { data } from './data/resource.js';

const backend = defineBackend({
  auth,
  data
});

// create function stack for the auth triggers
const authTriggerStack = backend.getStack('AuthTriggerStack');

// create the PostConfirmation trigger
const postConfirmationTrigger = new lambda.NodejsFunction(
  authTriggerStack,
  'PostConfirmation',
  {
    entry: url.fileURLToPath(
      new URL('./custom/post-confirmation.ts', import.meta.url)
    )
  }
);

// add the newly-created trigger to the auth resource
const userPool = backend.resources.auth.resources.userPool as cognito.UserPool;
userPool.addTrigger(
  cognito.UserPoolOperation.POST_CONFIRMATION,
  postConfirmationTrigger
);
```
