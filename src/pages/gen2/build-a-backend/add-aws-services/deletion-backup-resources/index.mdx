export const meta = {
  title: 'Deletion protection and Backup resources',
  description: 'Learn how to enable deletion protection and backup on resources'
};

export function getStaticProps(context) {
  return {
    props: {
      meta
    }
  };
}


<Callout warning>

Deleting a Amplify sandbox with a resource enabled with deletion protection, the deploy process will fail and the resource will need to be manually deleted on the AWS console. 

</Callout>

Using AWS CDK we can configure Amplify generated resource to enable deletion protection and backups on supported resources. For example, a developer can could use CDK to enable Point-in-time recovery for DynamoDB tables, or use AWS Backups as a advanced backup option.

Using underlying [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/latest/guide/home.html) construct properties you can modify resource configurations. This allows you to customize backend resources beyond what is offered via the `define*` functions.

In the `amplify/backend.ts` create a `backend` object that exposes resource properties with objects for each of the components passed into the `defineBackend` function.

```ts title="amplify/backend.ts"
import { defineBackend } from '@aws-amplify/backend';
import { auth } from './auth/resource';
import { data } from './data/resource';

const backend = defineBackend({
  auth,
  data
});
```

## Example - Enabling Deletion protection on a Auth resource

For example, if you would like to enable Deletion protection on a Cognito user pool resource created by Amplify Auth.

```ts title="amplify/backend.ts"
backend.auth.resources.cfnResources.cfnUserPool.deletionProtection ="ACTIVE";
```

## Example - Enabling Deletion protection on a Data resource

For example, if you would like to enable Deletion protection on all GraphQL API DynamoDB tables created by Amplify Data.

```ts title="amplify/backend.ts"
const dataResources = backend.data.resources;
for (const table of Object.values(dataResources.amplifyDynamoDbTables)) {
  table.deletionProtectionEnabled = true;
}
```

## Example - Enabling Point-in-time recovery for DynamoDB tables

For example, enabling Point-in-time recovery for all the DynamoDB tables created by GraphQL API.

```ts title="amplify/backend.ts"
const dataResources = backend.data.resources;
for (const table of Object.values(dataResources.amplifyDynamoDbTables)) {
  table.pointInTimeRecoveryEnabled = true;
}
```

## Example - Enabling Backups for DynamoDB tables

For example, if the default 35 days Point-in-time recovery on a DynamoDB table is not viable, we can utilize AWS Backup service to centralize and automate the backup of DynamoDB tables. 
The following example, creates a backup plan that applies to all the DynamoDB tables that runs every day at midnight. 

```ts title="amplify/backend.ts"
const tableNames = Object.keys(backend.data.resources.amplifyDynamoDbTables);
const backupStack = backend.createStack("amplify-backup");

const ITables = tableNames.map((tableName) =>
  Table.fromTableName(backupStack, tableName, tableName)
);

const vault = new backup.BackupVault(backupStack, "backup-vault", {
  backupVaultName: "amplify-backup-vault",
});

const plan = new backup.BackupPlan(backupStack, "backup-plan", {
  backupPlanName: "amplify-backup-plan",
  backupVault: vault,
});

plan.addRule(
  new backup.BackupPlanRule({
    deleteAfter: cdk.Duration.days(60),
    ruleName: "amplify-backup-plan-rule",
    scheduleExpression: events.Schedule.cron({
      minute: "0",
      hour: "0",
      day: "*",
      month: "*",
      year: "*",
    }),
  })
);

plan.addSelection("backup-plan-selection", {
  resources: ITables.map((table) =>
    backup.BackupResource.fromDynamoDbTable(table)
  ),
  allowRestores: true,
});
```
