The Auth category supports Multi-factor Authentication (MFA) for user sign-in flows. MFA is an extra layer of security 
used to make sure that users trying to gain access to an account are who they say they are. It requires users to provide 
additional information to verify their identity. The category supports the following MFA methods:

* [SMS](#multi-factor-authentication-with-sms)
* [TOTP](#multi-factor-authentication-with-totp) (Time-based One-time Password)

## Set Up Backend Resources

Below are the steps you can use to set up MFA using SMS or TOTP with the Amplify CLI. The Amplify libraries are designed to work with 
MFA even if you have set up your Amazon Cognito resources separately.

<Callout warning>

When using Amplify CLI to set up backend resources, the following options are only available when starting a new project (via `amplify add auth`). You will not have access to these settings after creation (via `amplify update`).

- Required MFA (i.e. Setting MFA to "ON")

</Callout>

<Callout>
Note: If you create or update an SMS MFA configuration for your Cognito user pool, the Cognito service will send a test SMS message to an internal number in order to verify your configuration. You will be charged for these test messages by Amazon SNS. 

Refer to [SMS sandbox](/lib/auth/sms_flows#sandbox-mode).

For information about Amazon SNS pricing, see [Worldwide SMS Pricing](https://aws.amazon.com/sns/sms-pricing/). 
</Callout>

<BlockSwitcher>

<Block name="New Project">

Run `amplify add auth` to create a new Cognito Auth resource, and follow the prompts below depending on how you want to integrate MFA into your flow.

Turning MFA "ON" will make it required for all users, while "Optional" will make it available to enable on a per-user basis.

import all2 from "/src/fragments/lib/auth/common/mfa/add_mfa.mdx";

<Fragments fragments={{all: all2}} />

</Block>

<Block name="Existing Auth">

Run `amplify update auth` and follow the prompts as guided below.

import all5 from "/src/fragments/lib/auth/common/mfa/update_mfa.mdx";

<Fragments fragments={{all: all5}} />

</Block>

</BlockSwitcher>

## Multi-factor authentication with SMS

<Callout>

<b>AWS Cognito Limitation</b>

The `fetchMFAPreference` API will only return enabled and preferred MFA methods, if the preferences were set using the `updateMFAPreference` API. If the preferences were not set using the `updateMFAPreference` API, the MFA preferences will return `nil` for enabled and preferred MFA methods. 

Therefore it is recommended to use the `updateMFAPreference` API to set the MFA preferences for the user, if the user decides to set up any MFA methods. An example use case would be that when a user successfully sets up TOTP using the `setupTOTP` and `verifyTOTPSetup` API, `updateMFAPreference` should be invoked to set the MFA preferences for the user i.e. marking TOTP as enabled.

</Callout>

### Enabling SMS for MFA during Sign Up

You will need to pass `phone_number` as a user attribute to enable SMS MFA for your users during sign up. If the primary login mechanism for your Cognito resource is 
`phone_number` (without enabling `username`), then you do not need to pass it as an attribute.

import flutter6 from "/src/fragments/lib/auth/flutter/sms/sign_up.mdx";

<Fragments fragments={{flutter: flutter6}} />

import iosSignUp from "/src/fragments/lib/auth/ios/sms/sign_up.mdx";

<Fragments fragments={{ios: iosSignUp}} />

By default, you have to verify a user account after they sign up using the `confirmSignUp` API, which will send a one-time password to the user's phone number or email, 
depending on your Amazon Cognito configuration.

import flutter7 from "/src/fragments/lib/auth/flutter/sms/confirm_sign_up.mdx";

<Fragments fragments={{flutter: flutter7}} />

import iosConfirmSignUp from "/src/fragments/lib/auth/ios/sms/confirm_sign_up.mdx";

<Fragments fragments={{ios: iosConfirmSignUp}} />

### Handling SMS MFA challenge during Sign In

After a user signs in, if they have MFA enabled for their account, a challenge will be returned that you would need to call the `confirmSignIn` API where the user provides 
their confirmation code sent to their phone number.

import flutter8 from "/src/fragments/lib/auth/flutter/sms/sign_in.mdx";

<Fragments fragments={{flutter: flutter8}} />

import iosSignInTOTP from "/src/fragments/lib/auth/ios/sms/sign_in.mdx";

<Fragments fragments={{ios: iosSignInTOTP}} />

If MFA is **ON** or enabled for the user, you must call `confirmSignIn` with the OTP sent to their phone.

import flutter9 from "/src/fragments/lib/auth/flutter/sms/confirm_sign_in.mdx";

<Fragments fragments={{flutter: flutter9}} />

import iosConfirmSignInTOTP from "/src/fragments/lib/auth/ios/sms/confirm_sign_in.mdx";

<Fragments fragments={{ios: iosConfirmSignInTOTP}} />

## Multi-factor authentication with TOTP

You can use Time-based One-Time Password (TOTP) for multi-factor authentication (MFA) in your web or mobile applications. The Amplify Auth category includes 
support for TOTP setup and verification using authenticator apps, offering an integrated solution and enhanced security for your users. These apps, 
such as Google Authenticator, Microsoft Authenticator, have the TOTP algorithm built-in and work by using a shared secret key and the current time to 
generate short-lived, six digit passwords.

<Callout>

<b>AWS Cognito Limitation</b>

The `fetchMFAPreference` API will only return enabled and preferred MFA methods, if the preferences were set using the `updateMFAPreference` API. If the preferences were not set using the `updateMFAPreference` API, the MFA preferences will return `nil` for enabled and preferred MFA methods. 

Therefore it is recommended to use the `updateMFAPreference` API to set the MFA preferences for the user, if the user decides to set up any MFA methods. An example use case would be that when a user successfully sets up TOTP using the `setupTOTP` and `verifyTOTPSetup` API, `updateMFAPreference` should be invoked to set the MFA preferences for the user i.e. marking TOTP as enabled.

</Callout>

### Setting up TOTP for a user

After you initiate a user sign in with the `signIn` API where a user is required to set up TOTP as an MFA method, the API call will return `continueSignInWithTOTPSetup` 
as a challenge and next step to handle in your app. You will get that challenge if the following conditions are met:

- MFA is marked as **Required** in Cognito User Pool.
- TOTP is enabled in the Cognito User Pool
- User does not have TOTP MFA set up already.

The `continueSignInWithTOTPSetup` step signifies that the user must set up TOTP before they can sign in. The step returns an associated value of type `TOTPSetupDetails` 
which must be used to configure an authenticator app like Microsoft Authenticator or Google Authenticator. `TOTPSetupDetails` provides a helper method called `getSetupURI` 
which generates a URI that can be used, for example, in a button to open the user's installed authenticator app. For more advanced use cases, `TOTPSetupDetails` also contains 
a `sharedSecret` which can be used to either generate a QR code or be manually entered into an authenticator app. 
 
Once the authenticator app is set up, the user can generate a TOTP code and provide it to the library to complete the sign in process.

import iosSignIn from "/src/fragments/lib/auth/ios/totp/sign_in.mdx";

<Fragments fragments={{ios: iosSignIn}} />

The TOTP code can be obtained from the user via a text field or any other means. Once the user provides the TOTP code, call `confirmSignIn` with the TOTP code as the `challengeResponse` parameter.

import iosConfirmSignIn from "/src/fragments/lib/auth/ios/totp/confirm_sign_in.mdx";

<Fragments fragments={{ios: iosConfirmSignIn}} />

### Enabling TOTP after a user is signed in

TOTP MFA can be set up after a user has signed in. This can be done when the following conditions are met:

- MFA is marked as **Optional** or **Required** in the Cognito User Pool
- TOTP is marked as an enabled MFA method in Cognito user pool

TOTP can be set up by calling the `setUpTOTP` and `verifyTOTPSetup` APIs in the `Auth` category.

Invoke the `setUpTOTP` API to generate a `TOTPSetupDetails` object which should be used to configure an Authenticator app like Microsoft Authenticator or Google Authenticator. `TOTPSetupDetails` provides a helper method called `getSetupURI` which generates a URI that can be used, for example, in a button to open the user's installed Authenticator app. For more advanced use cases, `TOTPSetupDetails` also contains a `sharedSecret` which can be used to either generate a QR code or be manually entered into an Authenticator app.

that contains the `sharedSecret` which will be used to either to generate a QR code or can be manually entered into an Authenticator app.

**`setUpTOTP` API**

import iosSetUpTOTP from "/src/fragments/lib/auth/ios/totp/set_up_totp.mdx";

<Fragments fragments={{ios: iosSetUpTOTP}} />

Once the Authenticator app is set up, the user must generate a TOTP code and provide it to the library. Pass the code to `verifyTOTPSetup` to complete the TOTP setup process.

**`verifyTOTPSetup` API**

import iosVerifyTOTPSetup from "/src/fragments/lib/auth/ios/totp/verify_totp_setup.mdx";

<Fragments fragments={{ios: iosVerifyTOTPSetup}} />

### Recovering from a lost TOTP device

<Callout warning>

If a user loses access to their TOTP device, they would need to contact an administrator to help get access to their account. Based on the Cognito User Pool configuration, the administrator can use the [AdminSetUserMFAPreference](https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminSetUserMFAPreference.html) to either change the MFA preference to a different MFA method or to disable MFA for the user.

</Callout>

In a scenario where MFA is marked as **Required** in Cognito User Pool and another MFA method is not set up, the administrator would need to first initiate an [AdminUpdateUserAttributes](https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminUpdateUserAttributes.html) call and update the userâ€™s phone number attribute. Once this is complete, the administrator can continue changing the MFA preference to SMS as suggested above.

## Setting a user's preferred MFA option

<Callout>

The APIs for fetching and updating MFA preferences are only available through AWS Cognito Auth plugin. The examples usage of the API's using the plugin is provided below. 

</Callout>

### Fetch the current user's MFA preferences

Invoke the following API to get the current MFA preference and enabled MFA types, if any, for the current user.

import iosFetchMFAPreference from "/src/fragments/lib/auth/ios/mfa_preference/10_fetch_mfa_preference.mdx";

<Fragments fragments={{ios: iosFetchMFAPreference}} />

### Update the current user's MFA preferences

Invoke the following API to update the MFA preference for the current user.

<Callout warning>

Only one MFA method can be marked as preferred at a time. If the user has multiple MFA methods enabled and tries to mark more than one MFA method as preferred, the API will throw an error.

</Callout>

import iosUpdateMFAPreferences from "/src/fragments/lib/auth/ios/mfa_preference/20_update_mfa_preference.mdx";

<Fragments fragments={{ios: iosUpdateMFAPreferences}} />

If multiple MFA methods are enabled for the user, the `signIn` API will return `continueSignInWithMFASelection` as the next step in the auth flow. During this scenario, the user should be prompted to select the MFA method they want to use to sign in.

<Callout>

Refer to the [Continue signin with MFA Selection](/lib/auth/signin_next_steps#continue-signin-with-mfa-selection) section for more details.

</Callout>